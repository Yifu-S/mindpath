<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MindPath - Private Mental Health Support for Students</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --secondary: #8b5cf6;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --dark: #1f2937;
        --gray: #6b7280;
        --light: #f3f4f6;
        --white: #ffffff;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        --shadow-lg:
          0 10px 20px rgba(0, 0, 0, 0.19), 0 6px 6px rgba(0, 0, 0, 0.23);
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: var(--dark);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Auth Screen */
      .auth-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }

      .auth-card {
        background: var(--white);
        border-radius: 20px;
        box-shadow: var(--shadow-lg);
        padding: 40px;
        width: 100%;
        max-width: 400px;
      }

      .logo {
        text-align: center;
        margin-bottom: 30px;
      }

      .logo h1 {
        color: var(--primary);
        font-size: 32px;
        margin-bottom: 10px;
      }

      .logo p {
        color: var(--gray);
        font-size: 14px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: var(--dark);
        font-weight: 500;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid var(--light);
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        background: #f9fafb;
      }

      .btn {
        background: var(--primary);
        color: var(--white);
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
      }

      .btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow);
      }

      .btn-secondary {
        background: var(--gray);
      }

      .btn-danger {
        background: var(--danger);
      }

      /* Main App */
      .app-container {
        display: none;
        background: var(--white);
        border-radius: 20px;
        box-shadow: var(--shadow-lg);
        margin-top: 20px;
        overflow: hidden;
      }

      .app-header {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: var(--white);
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .privacy-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .nav-tabs {
        display: flex;
        background: var(--light);
        border-bottom: 2px solid #e5e7eb;
        overflow-x: auto;
      }

      .nav-tab {
        padding: 15px 25px;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 600;
        color: var(--gray);
        transition: all 0.3s;
        white-space: nowrap;
      }

      .nav-tab.active {
        color: var(--primary);
        background: var(--white);
        border-bottom: 3px solid var(--primary);
      }

      .tab-content {
        display: none;
        padding: 30px;
        animation: fadeIn 0.5s;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Mood Tracker */
      .mood-tracker {
        text-align: center;
      }

      .current-mood {
        margin-bottom: 30px;
      }

      .mood-scale {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
      }

      .mood-button {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 3px solid var(--light);
        background: var(--white);
        cursor: pointer;
        font-size: 20px;
        transition: all 0.3s;
      }

      .mood-button:hover {
        transform: scale(1.1);
        border-color: var(--primary);
      }

      .mood-button.selected {
        border-color: var(--primary);
        background: var(--primary);
        color: var(--white);
      }

      .emotion-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
      }

      .emotion-tag {
        padding: 8px 16px;
        border-radius: 20px;
        border: 2px solid var(--light);
        background: var(--white);
        cursor: pointer;
        transition: all 0.3s;
      }

      .emotion-tag.selected {
        background: var(--secondary);
        color: var(--white);
        border-color: var(--secondary);
      }

      /* Journal */
      .journal-entry {
        margin-bottom: 20px;
      }

      .journal-prompt {
        background: var(--light);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        font-style: italic;
        color: var(--gray);
      }

      textarea.journal-input {
        min-height: 200px;
        resize: vertical;
      }

      .ai-response {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        border-left: 4px solid var(--primary);
      }

      .journal-history {
        margin-top: 30px;
      }

      .journal-item {
        background: var(--light);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .journal-item:hover {
        background: #e5e7eb;
        transform: translateX(5px);
      }

      /* Insights */
      .chart-container {
        background: var(--light);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .mood-chart {
        height: 300px;
        display: flex;
        align-items: flex-end;
        justify-content: space-around;
        gap: 10px;
      }

      .chart-bar {
        background: linear-gradient(to top, var(--primary), var(--secondary));
        border-radius: 5px 5px 0 0;
        width: 40px;
        transition: all 0.3s;
        position: relative;
      }

      .chart-bar:hover {
        opacity: 0.8;
      }

      .chart-label {
        position: absolute;
        bottom: -25px;
        font-size: 12px;
        width: 100%;
        text-align: center;
      }

      .pattern-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .pattern-card {
        background: var(--white);
        padding: 20px;
        border-radius: 10px;
        box-shadow: var(--shadow);
        border-left: 4px solid var(--primary);
      }

      .pattern-card h4 {
        color: var(--primary);
        margin-bottom: 10px;
      }

      /* Privacy Settings */
      .privacy-section {
        background: var(--light);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .privacy-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #e5e7eb;
      }

      .privacy-option:last-child {
        border-bottom: none;
      }

      .toggle {
        position: relative;
        width: 60px;
        height: 30px;
        background: var(--gray);
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .toggle.active {
        background: var(--success);
      }

      .toggle-slider {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 24px;
        height: 24px;
        background: var(--white);
        border-radius: 50%;
        transition: all 0.3s;
      }

      .toggle.active .toggle-slider {
        left: 33px;
      }

      /* Crisis Support */
      .crisis-banner {
        background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        color: var(--white);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      }

      .crisis-banner h3 {
        margin-bottom: 10px;
      }

      .crisis-resources {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .resource-card {
        background: var(--white);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        box-shadow: var(--shadow);
      }

      .resource-card h4 {
        color: var(--primary);
        margin-bottom: 5px;
      }

      /* Loading and Alerts */
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid var(--light);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .alert {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: none;
      }

      .alert.success {
        background: #d1fae5;
        color: #065f46;
        border-left: 4px solid var(--success);
      }

      .alert.error {
        background: #fee2e2;
        color: #991b1b;
        border-left: 4px solid var(--danger);
      }

              /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .auth-card {
                padding: 25px;
            }

            .mood-scale {
                flex-wrap: wrap;
                gap: 5px;
            }

            .mood-button {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .pattern-cards {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                overflow-x: scroll;
                -webkit-overflow-scrolling: touch;
                font-size: 14px;
            }

            .nav-tab {
                padding: 12px 15px;
                white-space: nowrap;
            }

            .emotion-tags {
                gap: 8px;
            }

            .emotion-tag {
                padding: 6px 12px;
                font-size: 14px;
            }

            .tab-content {
                padding: 20px;
            }

            .app-header {
                padding: 15px;
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
            }

            .privacy-badge {
                font-size: 10px;
                padding: 3px 8px;
            }
        }

        @media (max-width: 480px) {
            .auth-card {
                padding: 20px;
                margin: 10px;
            }

            .mood-scale {
                gap: 3px;
            }

            .mood-button {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }

            .nav-tab {
                padding: 10px 12px;
                font-size: 12px;
            }

            .tab-content {
                padding: 15px;
            }

            .pattern-card {
                padding: 15px;
            }
        }

      /* Animations */
      .pulse {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .slide-in {
        animation: slideIn 0.5s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateX(-100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <!-- Auth Container -->
    <div id="authContainer" class="auth-container">
      <div class="auth-card">
        <div class="logo">
          <h1>🧠 MindPath</h1>
          <p>Your Private Mental Health Companion</p>
        </div>

        <div id="loginForm">
          <h2 style="text-align: center; margin-bottom: 20px">Welcome Back</h2>
          <div class="form-group">
            <label>Username (Anonymous)</label>
            <input
              type="text"
              id="username"
              placeholder="Choose any username"
            />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input
              type="password"
              id="password"
              placeholder="Your secure password"
            />
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="rememberDevice" /> Remember this device
              (encrypted)
            </label>
          </div>
          <button type="button" class="btn" onclick="login()">
            Enter MindPath
          </button>
          <p style="text-align: center; margin-top: 20px; color: var(--gray)">
            New here?
            <a
              href="#"
              onclick="showSignup(); return false;"
              style="color: var(--primary)"
              >Create Account</a
            >
          </p>
        </div>

        <div id="signupForm" style="display: none">
          <h2 style="text-align: center; margin-bottom: 20px">
            Create Your Safe Space
          </h2>
          <div class="form-group">
            <label>Choose Username</label>
            <input
              type="text"
              id="newUsername"
              placeholder="Any name you want"
            />
          </div>
          <div class="form-group">
            <label>Create Password</label>
            <input
              type="password"
              id="newPassword"
              placeholder="Strong password"
            />
          </div>
          <div class="form-group">
            <label>Year in School</label>
            <select id="yearInSchool">
              <option value="">Select...</option>
              <option value="freshman">Freshman</option>
              <option value="sophomore">Sophomore</option>
              <option value="junior">Junior</option>
              <option value="senior">Senior</option>
              <option value="graduate">Graduate Student</option>
            </select>
          </div>
          <button type="button" class="btn" onclick="signup()">
            Create Account
          </button>
          <p style="text-align: center; margin-top: 20px; color: var(--gray)">
            Have an account?
            <a
              href="#"
              onclick="showLogin(); return false;"
              style="color: var(--primary)"
              >Sign In</a
            >
          </p>
        </div>

        <div
          style="
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--light);
          "
        >
          <p style="text-align: center; color: var(--gray); font-size: 12px">
            🔒 End-to-end encrypted • No real names required<br />
            📵 No institutional tracking • Your data stays yours
          </p>
        </div>
      </div>
    </div>

    <!-- Main App Container -->
    <div class="container">
      <div id="appContainer" class="app-container">
        <div class="app-header">
          <div>
            <h2>🧠 MindPath</h2>
            <p style="opacity: 0.9; font-size: 14px">
              Your mental health, your privacy
            </p>
          </div>
          <div class="user-info">
            <div class="privacy-badge">
              <span>🔒</span>
              <span>Encrypted</span>
            </div>
            <button
              class="btn btn-secondary"
              style="width: auto"
              onclick="logout()"
            >
              Logout
            </button>
          </div>
        </div>

        <div class="nav-tabs">
          <button class="nav-tab active" onclick="switchTab('mood')">
            Mood Check-In
          </button>
          <button class="nav-tab" onclick="switchTab('journal')">
            Journal
          </button>
          <button class="nav-tab" onclick="switchTab('insights')">
            Insights
          </button>
          <button class="nav-tab" onclick="switchTab('calendar')">
            Academic Calendar
          </button>
          <button class="nav-tab" onclick="switchTab('strategies')">
            Coping Strategies
          </button>
          <button class="nav-tab" onclick="switchTab('privacy')">
            Privacy Settings
          </button>
          <button class="nav-tab" onclick="switchTab('crisis')">
            Crisis Support
          </button>
        </div>

        <!-- Mood Tab -->
        <div id="moodTab" class="tab-content active">
          <div class="mood-tracker">
            <div class="current-mood">
              <h3>How are you feeling right now?</h3>
              <p style="color: var(--gray); margin-top: 10px">
                Your mood is encrypted and never shared
              </p>
            </div>

            <div class="mood-scale">
              <button class="mood-button" onclick="selectMood(1)">😔</button>
              <button class="mood-button" onclick="selectMood(2)">😟</button>
              <button class="mood-button" onclick="selectMood(3)">😕</button>
              <button class="mood-button" onclick="selectMood(4)">😐</button>
              <button class="mood-button" onclick="selectMood(5)">🙂</button>
              <button class="mood-button" onclick="selectMood(6)">😊</button>
              <button class="mood-button" onclick="selectMood(7)">😄</button>
              <button class="mood-button" onclick="selectMood(8)">😃</button>
              <button class="mood-button" onclick="selectMood(9)">😁</button>
              <button class="mood-button" onclick="selectMood(10)">🤩</button>
            </div>

            <h4 style="margin-top: 30px">
              What emotions are you experiencing?
            </h4>
            <div class="emotion-tags">
              <button class="emotion-tag" onclick="toggleEmotion(this)">
                Anxious
              </button>
              <button class="emotion-tag" onclick="toggleEmotion(this)">
                Stressed
              </button>
              <button class="emotion-tag" onclick="toggleEmotion(this)">
                Overwhelmed
              </button>
              <button class="emotion-tag" onclick="toggleEmotion(this)">
                Lonely
              </button>
              <button class="emotion-tag" onclick="toggleEmotion(this)">
                Homesick
              </button>
              <button class="emotion-tag" onclick="toggleEmotion(this)">
                Exhausted
              </button>
              <button class="emotion-tag" onclick="toggleEmotion(this)">
                Confident
              </button>
              <button class="emotion-tag" onclick="toggleEmotion(this)">
                Motivated
              </button>
              <button class="emotion-tag" onclick="toggleEmotion(this)">
                Content
              </button>
              <button class="emotion-tag" onclick="toggleEmotion(this)">
                Excited
              </button>
              <button class="emotion-tag" onclick="toggleEmotion(this)">
                Frustrated
              </button>
              <button class="emotion-tag" onclick="toggleEmotion(this)">
                Worried
              </button>
            </div>

            <h4 style="margin-top: 30px">What's the main context?</h4>
            <div class="emotion-tags">
              <button class="emotion-tag" onclick="selectContext(this)">
                Exams/Tests
              </button>
              <button class="emotion-tag" onclick="selectContext(this)">
                Assignments
              </button>
              <button class="emotion-tag" onclick="selectContext(this)">
                Social Life
              </button>
              <button class="emotion-tag" onclick="selectContext(this)">
                Relationships
              </button>
              <button class="emotion-tag" onclick="selectContext(this)">
                Family
              </button>
              <button class="emotion-tag" onclick="selectContext(this)">
                Financial
              </button>
              <button class="emotion-tag" onclick="selectContext(this)">
                Career/Future
              </button>
              <button class="emotion-tag" onclick="selectContext(this)">
                Health
              </button>
            </div>

            <button
              class="btn pulse"
              style="margin-top: 30px; max-width: 300px"
              onclick="saveMoodEntry()"
            >
              Save Mood Check-In
            </button>
          </div>
        </div>

        <!-- Journal Tab -->
        <div id="journalTab" class="tab-content">
          <div class="journal-entry">
            <h3>Private Journal Entry</h3>
            <div class="journal-prompt" id="journalPrompt">
              💭 What's on your mind today? This space is completely private and
              encrypted.
            </div>
            <textarea
              class="journal-input"
              id="journalText"
              placeholder="Write freely... Your thoughts are safe here."
            ></textarea>
            <button
              class="btn"
              onclick="processJournal()"
              style="margin-top: 15px"
            >
              Get AI Support
            </button>

            <div class="ai-response" id="aiResponse" style="display: none">
              <h4>AI Insights</h4>
              <p id="aiResponseText"></p>
            </div>
          </div>

          <div class="journal-history">
            <h3>Recent Entries (Encrypted)</h3>
            <div id="journalHistory">
              <!-- Journal entries will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Insights Tab -->
        <div id="insightsTab" class="tab-content">
          <h3>Your Mood Patterns</h3>
          <div class="chart-container">
            <h4>Last 7 Days</h4>
            <div class="mood-chart" id="moodChart">
              <!-- Chart will be generated here -->
            </div>
          </div>

          <h3 style="margin-top: 30px">Detected Patterns</h3>
          <div class="pattern-cards" id="patternCards">
            <div class="pattern-card">
              <h4>📊 Loading Patterns...</h4>
              <p>Analyzing your mood and journal data...</p>
            </div>
          </div>

          <h3 style="margin-top: 30px">Journal Insights</h3>
          <div class="pattern-cards" id="journalInsights">
            <div class="pattern-card">
              <h4>📝 Loading Journal Data...</h4>
              <p>Analyzing your writing patterns...</p>
            </div>
          </div>
        </div>

                    <!-- Academic Calendar Tab -->
            <div id="calendarTab" class="tab-content">
                <h3>Academic Calendar</h3>
                <p style="color: var(--gray); margin-bottom: 20px;">Track important academic events and deadlines</p>
                
                <div class="form-group" style="margin-bottom: 30px;">
                    <h4>Add New Event</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <input type="text" id="eventType" placeholder="Event Type (e.g., Exam, Assignment)">
                        <input type="date" id="eventDate">
                        <button class="btn" onclick="addCalendarEvent()">Add Event</button>
                    </div>
                    <textarea id="eventDescription" placeholder="Description (optional)" style="height: 80px;"></textarea>
                </div>

                <h4>Upcoming Events</h4>
                <div id="calendarEvents" class="pattern-cards">
                    <div class="pattern-card">
                        <h4>📅 Loading Events...</h4>
                        <p>Loading your academic calendar...</p>
                    </div>
                </div>
            </div>

            <!-- Coping Strategies Tab -->
            <div id="strategiesTab" class="tab-content">
                <h3>Personalized Coping Strategies</h3>
                <div class="pattern-cards" id="strategiesContainer">
                    <div class="pattern-card">
                        <h4>🧘 Loading Strategies...</h4>
                        <p>Finding personalized coping techniques for you...</p>
                    </div>
                </div>
            </div>

        <!-- Privacy Settings Tab -->
        <div id="privacyTab" class="tab-content">
          <h3>Privacy & Security Settings</h3>

          <div class="privacy-section">
            <h4>Data Storage</h4>
            <div class="privacy-option">
              <div>
                <strong>Local-Only Mode</strong>
                <p style="color: var(--gray); font-size: 14px">
                  Store all data only on this device
                </p>
              </div>
              <div class="toggle active" onclick="toggleSetting(this)">
                <div class="toggle-slider"></div>
              </div>
            </div>
            <div class="privacy-option">
              <div>
                <strong>Auto-Delete Old Entries</strong>
                <p style="color: var(--gray); font-size: 14px">
                  Remove entries older than 30 days
                </p>
              </div>
              <div class="toggle" onclick="toggleSetting(this)">
                <div class="toggle-slider"></div>
              </div>
            </div>
          </div>

          <div class="privacy-section">
            <h4>Security</h4>
            <div class="privacy-option">
              <div>
                <strong>Require Password on Open</strong>
                <p style="color: var(--gray); font-size: 14px">
                  Ask for password every time app opens
                </p>
              </div>
              <div class="toggle active" onclick="toggleSetting(this)">
                <div class="toggle-slider"></div>
              </div>
            </div>
            <div class="privacy-option">
              <div>
                <strong>Session Timeout</strong>
                <p style="color: var(--gray); font-size: 14px">
                  Auto-logout after 15 minutes inactive
                </p>
              </div>
              <div class="toggle active" onclick="toggleSetting(this)">
                <div class="toggle-slider"></div>
              </div>
            </div>
          </div>

          <div class="privacy-section" style="background: #fee2e2">
            <h4 style="color: var(--danger)">Danger Zone</h4>
            <button class="btn btn-danger" onclick="exportData()">
              Export All Data
            </button>
            <button
              class="btn btn-danger"
              onclick="deleteAllData()"
              style="margin-top: 10px"
            >
              Delete All Data
            </button>
            <p style="color: var(--danger); font-size: 12px; margin-top: 10px">
              ⚠️ This action cannot be undone
            </p>
          </div>
        </div>

        <!-- Crisis Support Tab -->
        <div id="crisisTab" class="tab-content">
          <div class="crisis-banner">
            <h3>📞 If you're in crisis, help is available</h3>
            <p>
              You don't have to go through this alone. Reach out for support.
            </p>
          </div>

          <div class="crisis-resources">
            <div class="resource-card">
              <h4>988</h4>
              <p>Suicide & Crisis Lifeline</p>
              <small>24/7 Free & Confidential</small>
            </div>
            <div class="resource-card">
              <h4>741741</h4>
              <p>Crisis Text Line</p>
              <small>Text HOME to start</small>
            </div>
            <div class="resource-card">
              <h4>Campus Counseling</h4>
              <p>Your University Services</p>
              <small>Professional support</small>
            </div>
            <div class="resource-card">
              <h4>911</h4>
              <p>Emergency Services</p>
              <small>Immediate danger</small>
            </div>
          </div>

          <div
            style="
              margin-top: 30px;
              padding: 20px;
              background: var(--light);
              border-radius: 10px;
            "
          >
            <h4>Warning Signs to Watch For:</h4>
            <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8">
              <li>Thoughts of self-harm or suicide</li>
              <li>Feeling hopeless or having no purpose</li>
              <li>Increased alcohol or drug use</li>
              <li>Withdrawing from activities and isolating</li>
              <li>Extreme mood swings</li>
              <li>Unable to sleep or sleeping all the time</li>
            </ul>
            <p
              style="margin-top: 15px; color: var(--primary); font-weight: 600"
            >
              If you notice these signs, please reach out for help immediately.
            </p>
          </div>
        </div>

        <!-- Alerts -->
        <div class="alert success" id="successAlert"></div>
        <div class="alert error" id="errorAlert"></div>
      </div>
    </div>

    <script>
      // Encryption utilities
      const CryptoUtils = {
        async generateKey(password, salt) {
          const encoder = new TextEncoder();
          const keyMaterial = await crypto.subtle.importKey(
            "raw",
            encoder.encode(password),
            "PBKDF2",
            false,
            ["deriveBits", "deriveKey"]
          );

          return crypto.subtle.deriveKey(
            {
              name: "PBKDF2",
              salt: encoder.encode(salt),
              iterations: 100000,
              hash: "SHA-256",
            },
            keyMaterial,
            { name: "AES-GCM", length: 256 },
            false,
            ["encrypt", "decrypt"]
          );
        },

        async encrypt(text, password) {
          const encoder = new TextEncoder();
          const salt = crypto.getRandomValues(new Uint8Array(16));
          const iv = crypto.getRandomValues(new Uint8Array(12));
          const key = await this.generateKey(password, salt);

          const encrypted = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv },
            key,
            encoder.encode(text)
          );

          return {
            encrypted: Array.from(new Uint8Array(encrypted)),
            salt: Array.from(salt),
            iv: Array.from(iv),
          };
        },

        async decrypt(encryptedData, password) {
          const decoder = new TextDecoder();
          const key = await this.generateKey(
            password,
            new Uint8Array(encryptedData.salt)
          );

          const decrypted = await crypto.subtle.decrypt(
            { name: "AES-GCM", iv: new Uint8Array(encryptedData.iv) },
            key,
            new Uint8Array(encryptedData.encrypted)
          );

          return decoder.decode(decrypted);
        },
      };

      // Local Storage Manager
      const StorageManager = {
        setItem(key, value) {
          localStorage.setItem(key, JSON.stringify(value));
        },

        getItem(key) {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : null;
        },

        removeItem(key) {
          localStorage.removeItem(key);
        },

        clear() {
          localStorage.clear();
        },
      };

      // App State
      let currentUser = null;
      let currentMood = null;
      let selectedEmotions = [];
      let selectedContext = null;

      // Auth Functions
      function showLogin() {
        document.getElementById("loginForm").style.display = "block";
        document.getElementById("signupForm").style.display = "none";
        return false; // Prevent default link behavior
      }

      function showSignup() {
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("signupForm").style.display = "block";
        return false; // Prevent default link behavior
      }

      async function login() {
        console.log("Login function called");
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        if (!username || !password) {
          showError("Please enter username and password");
          return false;
        }

        try {
          console.log("Attempting login for:", username);
          // Call API for authentication
          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              username: username,
              password: password,
            }),
          });

          const data = await response.json();
          console.log("Login response:", response.status, data);

          if (response.ok) {
            // Store token and user info
            localStorage.setItem("token", data.token);
            currentUser = {
              id: data.user.id,
              username: data.user.username,
              password: password, // Keep for local encryption
              yearInSchool: data.user.yearInSchool,
            };
            StorageManager.setItem("currentUser", currentUser);
            showApp();
            showSuccess("Login successful!");
          } else {
            showError(data.error || "Login failed");
          }
        } catch (error) {
          console.error("Login error:", error);
          showError(
            "Connection error. Please check if the server is running on port 3000."
          );
        }
        return false;
      }

      async function signup() {
        console.log("Signup function called");
        const username = document.getElementById("newUsername").value;
        const password = document.getElementById("newPassword").value;
        const year = document.getElementById("yearInSchool").value;

        if (!username || !password || !year) {
          showError("Please fill all fields");
          return false;
        }

        try {
          console.log("Attempting signup for:", username);
          // Call API for registration
          const response = await fetch("/api/auth/signup", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              username: username,
              password: password,
              yearInSchool: year,
            }),
          });

          const data = await response.json();
          console.log("Signup response:", response.status, data);

          if (response.ok) {
            // Store token and user info
            localStorage.setItem("token", data.token);
            currentUser = {
              id: data.user.id,
              username: data.user.username,
              password: password, // Keep for local encryption
              yearInSchool: year,
            };
            StorageManager.setItem("currentUser", currentUser);
            showApp();
            showSuccess("Account created successfully!");
          } else {
            showError(data.error || "Registration failed");
          }
        } catch (error) {
          console.error("Signup error:", error);
          showError(
            "Connection error. Please check if the server is running on port 3000."
          );
        }
        return false;
      }

      function logout() {
        currentUser = null;
        StorageManager.removeItem("currentUser");
        document.getElementById("authContainer").style.display = "flex";
        document.getElementById("appContainer").style.display = "none";
      }

      function showApp() {
        document.getElementById("authContainer").style.display = "none";
        document.getElementById("appContainer").style.display = "block";
        loadUserData();
        generateMoodChart();
        updateJournalPrompt();
        loadInsights();
        loadStrategies();
        loadCalendarEvents();
      }

      // Tab Navigation
      function switchTab(tabName) {
        // Remove active class from all tabs and contents
        document
          .querySelectorAll(".nav-tab")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));

        // Add active class to selected tab
        event.target.classList.add("active");
        document.getElementById(tabName + "Tab").classList.add("active");
      }

      // Mood Tracking
      function selectMood(mood) {
        currentMood = mood;
        document.querySelectorAll(".mood-button").forEach((btn, index) => {
          btn.classList.toggle("selected", index + 1 === mood);
        });
      }

      function toggleEmotion(element) {
        element.classList.toggle("selected");
        const emotion = element.textContent;
        if (element.classList.contains("selected")) {
          selectedEmotions.push(emotion);
        } else {
          selectedEmotions = selectedEmotions.filter((e) => e !== emotion);
        }
      }

      function selectContext(element) {
        document.querySelectorAll(".emotion-tags button").forEach((btn) => {
          if (btn.parentElement === element.parentElement && btn !== element) {
            btn.classList.remove("selected");
          }
        });
        element.classList.toggle("selected");
        selectedContext = element.classList.contains("selected")
          ? element.textContent
          : null;
      }

      async function saveMoodEntry() {
        if (!currentMood) {
          showError("Please select your mood level");
          return;
        }

        const moodEntry = {
          mood: currentMood,
          emotions: selectedEmotions,
          context: selectedContext,
          timestamp: Date.now(),
          date: new Date().toLocaleDateString(),
        };

        try {
          // Send to API
          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("No authentication token");
          }

          const response = await fetch("/api/mood", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(moodEntry),
          });

          const data = await response.json();

          if (response.ok) {
            showSuccess("Mood check-in saved securely!");

            // Reset selections
            currentMood = null;
            selectedEmotions = [];
            selectedContext = null;
            document
              .querySelectorAll(".mood-button, .emotion-tag")
              .forEach((btn) => btn.classList.remove("selected"));

                                // Update chart and insights
                    generateMoodChart();
                    loadInsights();
                    
                    // Check for concerning patterns
                    checkForConcerningPatterns(moodEntry);
          } else {
            showError(data.error || "Failed to save mood entry");
          }
        } catch (error) {
          console.error("Save mood error:", error);

          // Fallback to local storage if no token or API error
          if (!currentUser || !currentUser.password) {
            showError("Unable to save mood entry. Please log in again.");
            return;
          }

          const userData = StorageManager.getItem(
            `user_${currentUser.username}`
          ) || { moods: [], journals: [] };
          const encryptedMood = await CryptoUtils.encrypt(
            JSON.stringify(moodEntry),
            currentUser.password
          );
          userData.moods.push(encryptedMood);
          StorageManager.setItem(`user_${currentUser.username}`, userData);
          showSuccess("Mood check-in saved locally!");

          // Reset and update
          currentMood = null;
          selectedEmotions = [];
          selectedContext = null;
          document
            .querySelectorAll(".mood-button, .emotion-tag")
            .forEach((btn) => btn.classList.remove("selected"));
          generateMoodChart();
        }
      }

      // Journal Functions
      async function processJournal() {
        const journalText = document.getElementById("journalText").value;
        if (!journalText) {
          showError("Please write something in your journal");
          return;
        }

        try {
          // Send to API for AI processing
          const token = localStorage.getItem("token");
          const response = await fetch("/api/journal", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ text: journalText }),
          });

          const data = await response.json();

          if (response.ok) {
            // Display AI response
            document.getElementById("aiResponseText").textContent =
              data.aiResponse;
            document.getElementById("aiResponse").style.display = "block";
            showSuccess("Journal entry saved and processed!");
            loadJournalHistory();
            loadInsights();
          } else {
            // Fallback to local processing
            throw new Error(data.error);
          }
        } catch (error) {
          console.error("Journal API error:", error);

          // Fallback: Save locally and provide basic response
          const journalEntry = {
            text: journalText,
            timestamp: Date.now(),
            date: new Date().toLocaleDateString(),
          };

          const userData = StorageManager.getItem(
            `user_${currentUser.username}`
          ) || { moods: [], journals: [] };
          const encryptedJournal = await CryptoUtils.encrypt(
            JSON.stringify(journalEntry),
            currentUser.password
          );
          userData.journals.push(encryptedJournal);
          StorageManager.setItem(`user_${currentUser.username}`, userData);

          // Provide local AI response
          const aiResponse = generateAIResponse(journalText);
          document.getElementById("aiResponseText").textContent = aiResponse;
          document.getElementById("aiResponse").style.display = "block";

          showSuccess("Journal entry saved locally!");
          loadJournalHistory();
          loadInsights();
        }
      }

      function generateAIResponse(text) {
        // Simplified AI response simulation
        // In production, this would call your LLM API
        const responses = {
          stress:
            "I understand you're feeling stressed. Remember that it's normal to feel overwhelmed during college. Try breaking down your tasks into smaller, manageable pieces. Consider using the Pomodoro technique from the Coping Strategies tab.",
          anxiety:
            "Anxiety is a common experience for many students. The breathing exercises in the Coping Strategies section can help calm your nervous system. Also, remember that your campus counseling center is always available.",
          lonely:
            "Feeling lonely in college is more common than you might think. Consider joining a study group or campus organization. Small steps toward connection can make a big difference.",
          default:
            "Thank you for sharing. Your feelings are valid and it's healthy to express them. Based on what you've written, consider exploring the coping strategies that resonate most with you.",
        };

        // Simple keyword detection
        const lowerText = text.toLowerCase();
        if (lowerText.includes("stress") || lowerText.includes("overwhelm"))
          return responses.stress;
        if (lowerText.includes("anxious") || lowerText.includes("anxiety"))
          return responses.anxiety;
        if (lowerText.includes("lonely") || lowerText.includes("alone"))
          return responses.lonely;
        return responses.default;
      }

      function updateJournalPrompt() {
        const prompts = [
          "💭 What's on your mind today? This space is completely private and encrypted.",
          "📝 How did today go? What challenged you and what went well?",
          "🌟 What are three things you're grateful for today?",
          "🎯 What's one small goal you can set for tomorrow?",
          "💪 What strength did you discover in yourself recently?",
          "🌈 Describe a moment today that made you smile.",
          "📚 How are you balancing academics and self-care?",
          "🤝 How are your relationships affecting your wellbeing?",
        ];

        const randomPrompt =
          prompts[Math.floor(Math.random() * prompts.length)];
        document.getElementById("journalPrompt").textContent = randomPrompt;
      }

      async function loadJournalHistory() {
        const userData = StorageManager.getItem(
          `user_${currentUser.username}`
        ) || { moods: [], journals: [] };
        const historyContainer = document.getElementById("journalHistory");
        historyContainer.innerHTML = "";

        // Load last 5 journal entries
        const recentJournals = userData.journals.slice(-5).reverse();
        for (const encryptedJournal of recentJournals) {
          try {
            const decrypted = await CryptoUtils.decrypt(
              encryptedJournal,
              currentUser.password
            );
            const journal = JSON.parse(decrypted);

            const journalItem = document.createElement("div");
            journalItem.className = "journal-item";
            journalItem.innerHTML = `
                        <strong>${journal.date}</strong>
                        <p style="margin-top: 5px; color: var(--gray);">
                            ${journal.text.substring(0, 100)}${journal.text.length > 100 ? "..." : ""}
                        </p>
                    `;
            historyContainer.appendChild(journalItem);
          } catch (e) {
            console.error("Error decrypting journal entry");
          }
        }

        if (recentJournals.length === 0) {
          historyContainer.innerHTML =
            '<p style="color: var(--gray);">No journal entries yet. Start writing to track your thoughts!</p>';
        }
      }

      // Insights and Charts
      async function generateMoodChart() {
        const chartContainer = document.getElementById("moodChart");
        if (!chartContainer) return;

        chartContainer.innerHTML = "";

        try {
          const token = localStorage.getItem("token");
          if (token) {
            // Try to fetch from API
            const response = await fetch("/api/mood/history?limit=7", {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });

            if (response.ok) {
              const moodData = await response.json();

              // Get last 7 days
              const last7Days = [];
              const today = new Date();
              for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last7Days.push(date.toLocaleDateString());
              }

              // Aggregate mood data by day
              const moodsByDay = {};
              moodData.forEach((entry) => {
                const entryDate = new Date(entry.date).toLocaleDateString();
                if (last7Days.includes(entryDate)) {
                  if (!moodsByDay[entryDate]) {
                    moodsByDay[entryDate] = [];
                  }
                  moodsByDay[entryDate].push(entry.mood);
                }
              });

              // Create chart bars
              last7Days.forEach((date) => {
                const dayMoods = moodsByDay[date] || [];
                const avgMood =
                  dayMoods.length > 0
                    ? dayMoods.reduce((a, b) => a + b, 0) / dayMoods.length
                    : 0;

                const bar = document.createElement("div");
                bar.className = "chart-bar";
                bar.style.height = `${avgMood * 30}px`;

                const label = document.createElement("div");
                label.className = "chart-label";
                label.textContent =
                  date.split("/")[0] + "/" + date.split("/")[1];
                bar.appendChild(label);

                chartContainer.appendChild(bar);
              });
              return;
            }
          }
        } catch (error) {
          console.error("Error fetching mood history:", error);
        }

        // Fallback to local data
        const userData = StorageManager.getItem(
          `user_${currentUser.username}`
        ) || { moods: [], journals: [] };

        // Get last 7 days
        const last7Days = [];
        const today = new Date();
        for (let i = 6; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          last7Days.push(date.toLocaleDateString());
        }

        // Decrypt and aggregate mood data
        const moodsByDay = {};
        for (const encryptedMood of userData.moods) {
          try {
            const decrypted = await CryptoUtils.decrypt(
              encryptedMood,
              currentUser.password
            );
            const mood = JSON.parse(decrypted);
            if (last7Days.includes(mood.date)) {
              if (!moodsByDay[mood.date]) {
                moodsByDay[mood.date] = [];
              }
              moodsByDay[mood.date].push(mood.mood);
            }
          } catch (e) {
            console.error("Error decrypting mood entry");
          }
        }

        // Create chart bars
        last7Days.forEach((date) => {
          const dayMoods = moodsByDay[date] || [];
          const avgMood =
            dayMoods.length > 0
              ? dayMoods.reduce((a, b) => a + b, 0) / dayMoods.length
              : 0;

          const bar = document.createElement("div");
          bar.className = "chart-bar";
          bar.style.height = `${avgMood * 30}px`;

          const label = document.createElement("div");
          label.className = "chart-label";
          label.textContent = date.split("/")[0] + "/" + date.split("/")[1];
          bar.appendChild(label);

          chartContainer.appendChild(bar);
        });
      }

      // Privacy Functions
      function toggleSetting(element) {
        element.classList.toggle("active");
      }

      async function exportData() {
        if (
          !confirm(
            "Export all your data? This will create a downloadable file."
          )
        )
          return;

        const userData = StorageManager.getItem(
          `user_${currentUser.username}`
        ) || { moods: [], journals: [] };
        const dataStr = JSON.stringify(userData, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(dataBlob);
        link.download = `mindpath_backup_${Date.now()}.json`;
        link.click();

        showSuccess("Data exported successfully!");
      }

      function deleteAllData() {
        if (!confirm("Delete ALL your data? This cannot be undone!")) return;
        if (
          !confirm(
            "Are you absolutely sure? All mood tracking and journal entries will be permanently deleted."
          )
        )
          return;

        StorageManager.removeItem(`user_${currentUser.username}`);
        showSuccess("All data has been deleted");
        setTimeout(() => location.reload(), 1500);
      }

      // Pattern Detection
      function checkForConcerningPatterns(moodEntry) {
        // Check for consistently low mood
        if (moodEntry.mood <= 3) {
          const concerningEmotions = [
            "Anxious",
            "Stressed",
            "Overwhelmed",
            "Lonely",
          ];
          const hasConeerning = selectedEmotions.some((e) =>
            concerningEmotions.includes(e)
          );

          if (hasConeerning) {
            setTimeout(() => {
              if (
                confirm(
                  "We noticed you might be going through a tough time. Would you like to see crisis resources?"
                )
              ) {
                switchTab("crisis");
              }
            }, 2000);
          }
        }
      }

      // Utility Functions
      function showSuccess(message) {
        const alert = document.getElementById("successAlert");
        if (alert) {
          alert.textContent = message;
          alert.style.display = "block";
          setTimeout(() => (alert.style.display = "none"), 3000);
        } else {
          // Create alert if it doesn't exist
          const newAlert = document.createElement("div");
          newAlert.className = "alert success";
          newAlert.id = "successAlert";
          newAlert.textContent = message;
          newAlert.style.display = "block";
          document.body.appendChild(newAlert);
          setTimeout(() => (newAlert.style.display = "none"), 3000);
        }
      }

      function showError(message) {
        const alert = document.getElementById("errorAlert");
        if (alert) {
          alert.textContent = message;
          alert.style.display = "block";
          setTimeout(() => (alert.style.display = "none"), 3000);
        } else {
          // Create alert if it doesn't exist
          const newAlert = document.createElement("div");
          newAlert.className = "alert error";
          newAlert.id = "errorAlert";
          newAlert.textContent = message;
          newAlert.style.display = "block";
          newAlert.style.position = "fixed";
          newAlert.style.top = "20px";
          newAlert.style.right = "20px";
          newAlert.style.zIndex = "9999";
          document.body.appendChild(newAlert);
          setTimeout(() => (newAlert.style.display = "none"), 3000);
        }
        console.error("Error:", message);
      }

      async function loadUserData() {
        loadJournalHistory();
        generateMoodChart();
      }

      async function loadInsights() {
        try {
          const token = localStorage.getItem("token");
          if (!token) return;

          // Load mood patterns
          const moodResponse = await fetch("/api/insights/patterns", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (moodResponse.ok) {
            const moodData = await moodResponse.json();
            displayMoodPatterns(moodData);
          }

          // Load journal insights
          const journalResponse = await fetch("/api/insights/journal", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (journalResponse.ok) {
            const journalData = await journalResponse.json();
            displayJournalInsights(journalData);
          }
        } catch (error) {
          console.error("Error loading insights:", error);
        }
      }

      function displayMoodPatterns(data) {
        const container = document.getElementById("patternCards");
        if (!container) return;

        if (data.dataPoints === 0) {
          container.innerHTML = `
                    <div class="pattern-card">
                        <h4>📊 No Data Yet</h4>
                        <p>Start tracking your mood to see personalized insights!</p>
                    </div>
                `;
          return;
        }

        const patterns = [];

        // Mood trend
        if (data.moodTrend !== "neutral") {
          patterns.push({
            icon: data.moodTrend === "improving" ? "📈" : "📉",
            title: `Mood ${data.moodTrend.charAt(0).toUpperCase() + data.moodTrend.slice(1)}`,
            description: `Your mood has been ${data.moodTrend} over the past 30 days.`,
          });
        }

        // Common emotions
        if (data.commonEmotions.length > 0) {
          const topEmotion = data.commonEmotions[0];
          patterns.push({
            icon: "😊",
            title: "Most Common Emotion",
            description: `You've been feeling ${topEmotion.emotion.toLowerCase()} ${Math.round(topEmotion.frequency * 100)}% of the time.`,
          });
        }

        // Stress patterns
        if (data.stressPatterns.length > 0) {
          const topStress = data.stressPatterns[0];
          patterns.push({
            icon: "📚",
            title: "Academic Stress",
            description: `${topStress.context} appears in ${topStress.percentage}% of your mood entries.`,
          });
        }

        // Recommendations
        if (data.recommendations.length > 0) {
          const rec = data.recommendations[0];
          patterns.push({
            icon: "💡",
            title: rec.title,
            description: rec.description,
          });
        }

        // Fallback if no patterns detected
        if (patterns.length === 0) {
          patterns.push({
            icon: "📊",
            title: "Building Insights",
            description:
              "Continue tracking your mood to see personalized patterns and recommendations.",
          });
        }

        container.innerHTML = patterns
          .map(
            (pattern) => `
                <div class="pattern-card">
                    <h4>${pattern.icon} ${pattern.title}</h4>
                    <p>${pattern.description}</p>
                </div>
            `
          )
          .join("");
      }

      function displayJournalInsights(data) {
        const container = document.getElementById("journalInsights");
        if (!container) return;

        if (data.totalEntries === 0) {
          container.innerHTML = `
                    <div class="pattern-card">
                        <h4>📝 No Journal Entries</h4>
                        <p>Start journaling to see writing insights and patterns!</p>
                    </div>
                `;
          return;
        }

        const insights = [];

        // Writing frequency
        insights.push({
          icon: "📅",
          title: "Writing Frequency",
          description: `You write ${data.writingFrequency} with an average of ${data.averageLength} characters per entry.`,
        });

        // Common themes
        if (data.commonThemes.length > 0) {
          const topTheme = data.commonThemes[0];
          insights.push({
            icon: "🎯",
            title: "Common Theme",
            description: `You often write about ${topTheme.theme} (${topTheme.percentage}% of entries).`,
          });
        }

        // Total entries
        insights.push({
          icon: "📖",
          title: "Journal Activity",
          description: `You've written ${data.totalEntries} entries in the last 30 days.`,
        });

        container.innerHTML = insights
          .map(
            (insight) => `
                <div class="pattern-card">
                    <h4>${insight.icon} ${insight.title}</h4>
                    <p>${insight.description}</p>
                </div>
            `
          )
          .join("");
      }

      async function loadStrategies() {
        try {
          const token = localStorage.getItem("token");
          if (!token) return;

          const response = await fetch("/api/strategies", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            const strategies = await response.json();
            displayStrategies(strategies);
          }
        } catch (error) {
          console.error("Error loading strategies:", error);
          // Fallback to static strategies
          displayStrategies(getFallbackStrategies());
        }
      }

      function displayStrategies(strategies) {
        const container = document.getElementById("strategiesContainer");
        if (!container) return;

        if (strategies.length === 0) {
          container.innerHTML = `
                    <div class="pattern-card">
                        <h4>🧘 No Strategies Available</h4>
                        <p>Start tracking your mood to get personalized coping strategies!</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = strategies
          .map(
            (strategy) => `
                <div class="pattern-card">
                    <h4>${getStrategyIcon(strategy.category)} ${strategy.title}</h4>
                    <p><strong>${strategy.description}</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        ${strategy.steps.map((step) => `<li>${step}</li>`).join("")}
                    </ul>
                </div>
            `
          )
          .join("");
      }

      function getStrategyIcon(category) {
        const icons = {
          quick: "⚡",
          academic: "📚",
          sleep: "🌙",
          social: "🤝",
          stress: "🧘",
          focus: "🎯",
        };
        return icons[category] || "💡";
      }

      function getFallbackStrategies() {
        return [
          {
            id: 1,
            category: "quick",
            title: "Box Breathing (5 min)",
            description: "A simple technique to calm your nervous system",
            steps: [
              "Inhale for 4 counts",
              "Hold for 4 counts",
              "Exhale for 4 counts",
              "Hold for 4 counts",
              "Repeat 4-5 times",
            ],
          },
          {
            id: 2,
            category: "academic",
            title: "Pomodoro Technique",
            description: "Improve focus and reduce study stress",
            steps: [
              "25 minutes focused work",
              "5 minute break",
              "Repeat 4 times",
              "15-30 minute long break",
            ],
          },
        ];
      }

      // Calendar Functions
      async function loadCalendarEvents() {
        try {
          const token = localStorage.getItem("token");
          if (!token) return;

          const response = await fetch("/api/calendar/events", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            const events = await response.json();
            displayCalendarEvents(events);
          }
        } catch (error) {
          console.error("Error loading calendar events:", error);
          displayCalendarEvents([]);
        }
      }

      function displayCalendarEvents(events) {
        const container = document.getElementById("calendarEvents");
        if (!container) return;

        if (events.length === 0) {
          container.innerHTML = `
                    <div class="pattern-card">
                        <h4>📅 No Events</h4>
                        <p>Add academic events and deadlines to track them here.</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = events
          .map((event) => {
            const eventDate = new Date(event.event_date);
            const daysUntil =
              Math.ceil((eventDate - new Date()) / (1000 * 60 * 60 * 24));
            const daysText =
              daysUntil === 0
                ? "Today"
                : daysUntil === 1
                ? "Tomorrow"
                : daysUntil < 0
                ? `${Math.abs(daysUntil)} days ago`
                : `${daysUntil} days`;

            return `
                    <div class="pattern-card">
                        <h4>📅 ${event.event_type}</h4>
                        <p><strong>Date:</strong> ${eventDate.toLocaleDateString()}</p>
                        <p><strong>Time until:</strong> ${daysText}</p>
                        ${
                          event.description
                            ? `<p><strong>Description:</strong> ${event.description}</p>`
                            : ""
                        }
                    </div>
                `;
          })
          .join("");
      }

      async function addCalendarEvent() {
        const eventType = document.getElementById("eventType").value;
        const eventDate = document.getElementById("eventDate").value;
        const description = document.getElementById("eventDescription").value;

        if (!eventType || !eventDate) {
          showError("Please fill in event type and date");
          return;
        }

        try {
          const token = localStorage.getItem("token");
          if (!token) {
            showError("Please log in to add events");
            return;
          }

          const response = await fetch("/api/calendar/event", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              eventType,
              eventDate,
              description,
            }),
          });

          if (response.ok) {
            showSuccess("Event added successfully!");
            document.getElementById("eventType").value = "";
            document.getElementById("eventDate").value = "";
            document.getElementById("eventDescription").value = "";
            loadCalendarEvents();
          } else {
            const data = await response.json();
            showError(data.error || "Failed to add event");
          }
        } catch (error) {
          console.error("Error adding event:", error);
          showError("Failed to add event");
        }
      }

      // Session Management
      let inactivityTimer;
      function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(
          () => {
            if (currentUser) {
              logout();
              alert("Session expired for your security. Please log in again.");
            }
          },
          15 * 60 * 1000
        ); // 15 minutes
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        // Check for existing session
        const savedUser = StorageManager.getItem("currentUser");
        if (savedUser) {
          currentUser = savedUser;
          showApp();
        }

        // Set up inactivity timer
        document.addEventListener("click", resetInactivityTimer);
        document.addEventListener("keypress", resetInactivityTimer);
        resetInactivityTimer();
      });

      // Periodic journal prompt updates
      setInterval(updateJournalPrompt, 60000); // Change prompt every minute
    </script>
  </body>
</html>
