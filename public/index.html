<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MindPath - Private Mental Health Support for Students</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #8f7c4e;
        --primary-dark: #6b5b3a;
        --secondary: #a8c09a;
        --accent: #d4a574;
        --success: #7c9885;
        --warning: #e6b17a;
        --danger: #d67b7b;
        --dark: #2c2c2c;
        --gray: #6b6b6b;
        --light: #f8f6f2;
        --white: #ffffff;
        --cream: #faf8f4;
        --sage: #9caf88;
        --warm-gray: #8a8a8a;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.12);
        --shadow-lg:
          0 8px 25px rgba(0, 0, 0, 0.12), 0 4px 10px rgba(0, 0, 0, 0.08);
        --border-radius: 16px;
        --border-radius-sm: 12px;
      }

      body {
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          Oxygen,
          Ubuntu,
          sans-serif;
        background: linear-gradient(
          135deg,
          #f8f6f2 0%,
          #e8e4d8 50%,
          #d4c8b8 100%
        );
        min-height: 100vh;
        color: var(--dark);
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Auth Screen */
      .auth-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }

      .auth-card {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        padding: 50px 40px;
        width: 100%;
        max-width: 450px;
        border: 1px solid rgba(143, 124, 78, 0.1);
        backdrop-filter: blur(10px);
      }

      .logo {
        text-align: center;
        margin-bottom: 30px;
      }

      .logo h1 {
        color: var(--primary);
        font-size: 36px;
        margin-bottom: 12px;
        font-weight: 600;
        letter-spacing: -0.5px;
      }

      .logo p {
        color: var(--gray);
        font-size: 14px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: var(--dark);
        font-weight: 500;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 16px 18px;
        border: 2px solid var(--light);
        border-radius: var(--border-radius-sm);
        font-size: 16px;
        transition: all 0.3s ease;
        background: var(--cream);
        color: var(--dark);
        font-family: inherit;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        background: var(--white);
        box-shadow: 0 0 0 3px rgba(143, 124, 78, 0.1);
      }

      .btn {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: var(--white);
        border: none;
        padding: 16px 28px;
        border-radius: var(--border-radius-sm);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        background: linear-gradient(
          135deg,
          var(--primary-dark) 0%,
          var(--primary) 100%
        );
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn-secondary {
        background: var(--light);
        color: var(--text);
        border: 2px solid var(--accent);
        padding: 12px 24px;
        border-radius: var(--border-radius);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: inherit;
      }

      .btn-secondary:hover {
        background: var(--accent);
        color: var(--white);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .btn-logout {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: var(--white);
        border: none;
        padding: 12px 20px;
        border-radius: var(--border-radius-sm);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: var(--shadow);
      }

      .btn-logout:hover {
        background: linear-gradient(
          135deg,
          var(--primary-dark) 0%,
          var(--primary) 100%
        );
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
      }

      .btn-danger {
        background: var(--danger);
      }

      /* Main App */
      .app-container {
        display: none;
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        margin-top: 20px;
        overflow: hidden;
        border: 1px solid rgba(143, 124, 78, 0.1);
      }

      .app-header {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--accent) 50%,
          var(--secondary) 100%
        );
        color: var(--white);
        padding: 25px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
      }

      .app-header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(143, 124, 78, 0.1) 0%,
          rgba(168, 192, 154, 0.1) 100%
        );
        pointer-events: none;
      }

      .app-header > * {
        position: relative;
        z-index: 1;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .privacy-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .nav-tabs {
        display: flex;
        background: var(--cream);
        border-bottom: 2px solid rgba(143, 124, 78, 0.1);
        overflow-x: auto;
        padding: 0 20px;
      }

      .nav-tab {
        padding: 18px 28px;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 600;
        color: var(--warm-gray);
        transition: all 0.3s ease;
        white-space: nowrap;
        position: relative;
        border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0;
        margin: 0 2px;
      }

      .nav-tab:hover {
        color: var(--primary);
        background: rgba(143, 124, 78, 0.05);
      }

      .nav-tab.active {
        color: var(--primary);
        background: var(--white);
        border-bottom: 3px solid var(--primary);
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
      }

      .tab-content {
        display: none;
        padding: 40px;
        animation: fadeIn 0.5s ease-out;
        background: var(--white);
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Mood Tracker */
      .mood-tracker {
        text-align: center;
      }

      .current-mood {
        margin-bottom: 30px;
      }

      .mood-scale {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
      }

      .mood-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid var(--light);
        background: var(--white);
        cursor: pointer;
        font-size: 24px;
        transition: all 0.3s ease;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }

      .mood-button:hover {
        transform: scale(1.1);
        border-color: var(--primary);
        box-shadow: var(--shadow-lg);
      }

      .mood-button.selected {
        border-color: var(--primary);
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--accent) 100%
        );
        color: var(--white);
        box-shadow: 0 4px 15px rgba(143, 124, 78, 0.3);
      }

      .emotion-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
      }

      .emotion-tag {
        padding: 12px 20px;
        border-radius: 25px;
        border: 2px solid var(--light);
        background: var(--white);
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }

      .emotion-tag:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
        border-color: var(--sage);
      }

      .emotion-tag.selected {
        background: linear-gradient(
          135deg,
          var(--secondary) 0%,
          var(--sage) 100%
        );
        color: var(--white);
        border-color: var(--secondary);
        box-shadow: 0 4px 15px rgba(168, 192, 154, 0.3);
        transform: translateY(-1px);
      }

      /* Journal */
      .journal-entry {
        margin-bottom: 20px;
      }

      .journal-prompt {
        background: linear-gradient(135deg, var(--cream) 0%, var(--light) 100%);
        padding: 20px;
        border-radius: var(--border-radius-sm);
        margin-bottom: 20px;
        font-style: italic;
        color: var(--primary);
        border-left: 4px solid var(--accent);
        box-shadow: var(--shadow);
      }

      textarea.journal-input {
        min-height: 200px;
        resize: vertical;
      }

      .ai-response {
        background: linear-gradient(135deg, var(--cream) 0%, var(--light) 100%);
        padding: 25px;
        border-radius: var(--border-radius-sm);
        margin-top: 25px;
        border-left: 4px solid var(--secondary);
        box-shadow: var(--shadow);
        position: relative;
      }

      .ai-response::before {
        content: "üí≠";
        position: absolute;
        top: -10px;
        left: 20px;
        background: var(--white);
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 14px;
        box-shadow: var(--shadow);
      }

      .journal-history {
        margin-top: 30px;
      }

      .journal-item {
        background: var(--light);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .journal-item:hover {
        background: #e5e7eb;
        transform: translateX(5px);
      }

      /* Journal Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
      }

      .modal-overlay.show {
        display: flex;
      }

      .journal-modal {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        padding: 30px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        border: 1px solid rgba(143, 124, 78, 0.1);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--light);
      }

      .modal-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--primary);
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--gray);
        padding: 5px;
        border-radius: 50%;
        transition: all 0.3s;
      }

      .modal-close:hover {
        background: var(--light);
        color: var(--dark);
      }

      .journal-content {
        margin-bottom: 25px;
      }

      .journal-date {
        font-size: 14px;
        color: var(--gray);
        margin-bottom: 10px;
      }

      .journal-text {
        background: var(--cream);
        padding: 20px;
        border-radius: var(--border-radius-sm);
        line-height: 1.7;
        color: var(--dark);
        border-left: 4px solid var(--accent);
      }

      .ai-feedback {
        background: linear-gradient(135deg, var(--light) 0%, #f0f4f0 100%);
        padding: 20px;
        border-radius: var(--border-radius-sm);
        border-left: 4px solid var(--secondary);
      }

      .ai-feedback h4 {
        color: var(--primary);
        margin-bottom: 10px;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .ai-feedback-content {
        color: var(--dark);
        line-height: 1.6;
      }

      .mood-history-container {
        max-height: 600px;
        overflow-y: auto;
      }

      .mood-history-item {
        background: var(--light);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 15px;
        border-left: 4px solid var(--accent);
        transition: all 0.3s ease;
      }

      .mood-history-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .mood-history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .mood-history-date {
        font-weight: 600;
        color: var(--text);
      }

      .mood-history-time {
        color: var(--gray);
        font-size: 14px;
      }

      .mood-history-rating {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .mood-history-rating .mood-emoji {
        font-size: 24px;
      }

      .mood-history-rating .mood-score {
        font-weight: 600;
        color: var(--primary);
      }

      .mood-history-emotions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
      }

      .mood-history-emotion {
        background: var(--accent);
        color: var(--white);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
      }

      .mood-history-context {
        background: var(--cream);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 14px;
        color: var(--text);
        border-left: 3px solid var(--secondary);
      }

      /* Insights */
      .chart-container {
        background: var(--light);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .mood-chart {
        height: 300px;
        display: flex;
        align-items: flex-end;
        justify-content: space-around;
        gap: 10px;
      }

      .chart-bar {
        background: linear-gradient(
          to top,
          var(--primary) 0%,
          var(--accent) 50%,
          var(--secondary) 100%
        );
        border-radius: 8px 8px 0 0;
        width: 45px;
        transition: all 0.3s ease;
        position: relative;
        box-shadow: var(--shadow);
      }

      .chart-bar:hover {
        opacity: 0.9;
        transform: scale(1.05);
        box-shadow: var(--shadow-lg);
      }

      .chart-label {
        position: absolute;
        bottom: -25px;
        font-size: 12px;
        width: 100%;
        text-align: center;
      }

      .pattern-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .pattern-card {
        background: var(--white);
        padding: 25px;
        border-radius: var(--border-radius-sm);
        box-shadow: var(--shadow);
        border-left: 4px solid var(--primary);
        transition: all 0.3s ease;
        border: 1px solid rgba(143, 124, 78, 0.1);
        position: relative;
        overflow: hidden;
      }

      .pattern-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        border-color: rgba(143, 124, 78, 0.2);
      }

      .pattern-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--accent) 100%
        );
      }

      .pattern-card h4 {
        color: var(--primary);
        margin-bottom: 10px;
      }

      /* Privacy Settings */
      .privacy-section {
        background: linear-gradient(135deg, var(--cream) 0%, var(--light) 100%);
        padding: 25px;
        border-radius: var(--border-radius-sm);
        margin-bottom: 25px;
        border: 1px solid rgba(143, 124, 78, 0.1);
        box-shadow: var(--shadow);
      }

      .privacy-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #e5e7eb;
      }

      .privacy-option:last-child {
        border-bottom: none;
      }

      .toggle {
        position: relative;
        width: 60px;
        height: 30px;
        background: var(--gray);
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .toggle.active {
        background: var(--success);
      }

      .toggle-slider {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 24px;
        height: 24px;
        background: var(--white);
        border-radius: 50%;
        transition: all 0.3s;
      }

      .toggle.active .toggle-slider {
        left: 33px;
      }

      /* Crisis Support */
      .crisis-banner {
        background: linear-gradient(
          135deg,
          var(--danger) 0%,
          #c55a5a 50%,
          #b44a4a 100%
        );
        color: var(--white);
        padding: 30px;
        border-radius: var(--border-radius-sm);
        margin-bottom: 25px;
        text-align: center;
        box-shadow: var(--shadow-lg);
        position: relative;
        overflow: hidden;
      }

      .crisis-banner::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0.05) 100%
        );
        pointer-events: none;
      }

      .crisis-banner > * {
        position: relative;
        z-index: 1;
      }

      .crisis-banner h3 {
        margin-bottom: 10px;
      }

      .crisis-resources {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .resource-card {
        background: var(--white);
        padding: 20px;
        border-radius: var(--border-radius-sm);
        text-align: center;
        box-shadow: var(--shadow);
        border: 1px solid rgba(143, 124, 78, 0.1);
        transition: all 0.3s ease;
      }

      .resource-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        border-color: rgba(143, 124, 78, 0.2);
      }

      .resource-card h4 {
        color: var(--primary);
        margin-bottom: 5px;
      }

      /* Loading and Alerts */
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid var(--light);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .alert {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: none;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
      }

      .alert.success {
        background: #d1fae5;
        color: #065f46;
        border-left: 4px solid var(--success);
        position: fixed;
        top: 20px;
        right: 20px;
        min-width: 300px;
        max-width: 400px;
      }

      .alert.error {
        background: #dc2626;
        color: white;
        border: 3px solid #991b1b;
        position: fixed;
        top: 20px;
        right: 20px;
        min-width: 350px;
        max-width: 450px;
        z-index: 99999;
        font-weight: 700;
        font-size: 16px;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(220, 38, 38, 0.4);
        animation: slideIn 0.3s ease-out;
        text-align: center;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        .auth-card {
          padding: 30px 25px;
          margin: 10px;
        }

        .mood-scale {
          flex-wrap: wrap;
          gap: 8px;
        }

        .mood-button {
          width: 50px;
          height: 50px;
          font-size: 20px;
        }

        .pattern-cards {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .nav-tabs {
          overflow-x: scroll;
          -webkit-overflow-scrolling: touch;
          font-size: 14px;
          padding: 0 15px;
        }

        .nav-tab {
          padding: 15px 20px;
          white-space: nowrap;
          font-size: 13px;
        }

        .emotion-tags {
          gap: 10px;
        }

        .emotion-tag {
          padding: 10px 16px;
          font-size: 14px;
        }

        .tab-content {
          padding: 25px;
        }

        .app-header {
          padding: 20px;
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .user-info {
          flex-direction: column;
          gap: 15px;
        }

        .privacy-badge {
          font-size: 11px;
          padding: 5px 10px;
        }

        .pattern-card {
          padding: 20px;
        }

        .journal-prompt {
          padding: 15px;
        }

        .ai-response {
          padding: 20px;
        }
      }

      @media (max-width: 480px) {
        .auth-card {
          padding: 20px;
          margin: 10px;
        }

        .mood-scale {
          gap: 3px;
        }

        .mood-button {
          width: 35px;
          height: 35px;
          font-size: 14px;
        }

        .nav-tab {
          padding: 10px 12px;
          font-size: 12px;
        }

        .tab-content {
          padding: 15px;
        }

        .pattern-card {
          padding: 15px;
        }
      }

      /* Animations */
      .pulse {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .slide-in {
        animation: slideIn 0.5s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateX(-100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <!-- Auth Container -->
    <div id="authContainer" class="auth-container">
      <div class="auth-card">
        <div class="logo">
          <h1
            style="
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 15px;
              margin-bottom: 10px;
            "
          >
            <div
              style="
                width: 48px;
                height: 48px;
                background: linear-gradient(135deg, #8f7c4e 0%, #a8c09a 100%);
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 12px rgba(143, 124, 78, 0.3);
                font-size: 24px;
                color: white;
                font-weight: bold;
              "
            >
              M
            </div>
            MindPath
          </h1>
          <p>Your Private Mental Health Companion</p>
        </div>

        <div id="loginForm">
          <h2 style="text-align: center; margin-bottom: 20px">Welcome Back</h2>
          <div class="form-group">
            <label>Username (Anonymous)</label>
            <input
              type="text"
              id="username"
              placeholder="Choose any username"
            />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input
              type="password"
              id="password"
              placeholder="Your secure password"
            />
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="rememberDevice" /> Remember this device
              (encrypted)
            </label>
          </div>
          <button type="button" class="btn" onclick="login();">
            Enter MindPath
          </button>

          <p style="text-align: center; margin-top: 20px; color: var(--gray)">
            New here?
            <a
              href="#"
              onclick="showSignup(); return false;"
              style="color: var(--primary)"
              >Create Account</a
            >
          </p>
        </div>

        <div id="signupForm" style="display: none">
          <h2 style="text-align: center; margin-bottom: 20px">
            Create Your Safe Space
          </h2>
          <div class="form-group">
            <label>Choose Username</label>
            <input
              type="text"
              id="newUsername"
              placeholder="Any name you want"
            />
          </div>
          <div class="form-group">
            <label>Create Password</label>
            <input
              type="password"
              id="newPassword"
              placeholder="Strong password"
            />
          </div>
          <div class="form-group">
            <label>Year in School</label>
            <select id="yearInSchool">
              <option value="">Select...</option>
              <option value="freshman">Freshman</option>
              <option value="sophomore">Sophomore</option>
              <option value="junior">Junior</option>
              <option value="senior">Senior</option>
              <option value="graduate">Graduate Student</option>
            </select>
          </div>
          <button type="button" class="btn" onclick="signup()">
            Create Account
          </button>
          <p style="text-align: center; margin-top: 20px; color: var(--gray)">
            Have an account?
            <a
              href="#"
              onclick="showLogin(); return false;"
              style="color: var(--primary)"
              >Sign In</a
            >
          </p>
        </div>

        <div
          style="
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--light);
          "
        >
          <p style="text-align: center; color: var(--gray); font-size: 12px">
            üîí End-to-end encrypted ‚Ä¢ No real names required<br />
            üìµ No institutional tracking ‚Ä¢ Your data stays yours
          </p>
        </div>
      </div>
    </div>

    <!-- Main App Container -->
    <div class="container">
      <div id="appContainer" class="app-container">
        <div class="app-header">
          <div>
            <h2 style="display: flex; align-items: center; gap: 12px">
              <div
                style="
                  width: 32px;
                  height: 32px;
                  background: linear-gradient(135deg, #8f7c4e 0%, #a8c09a 100%);
                  border-radius: 8px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  box-shadow: 0 2px 8px rgba(143, 124, 78, 0.3);
                  font-size: 16px;
                  color: white;
                  font-weight: bold;
                "
              >
                M
              </div>
              MindPath
            </h2>
            <p style="opacity: 0.9; font-size: 14px">
              Your mental health, your privacy
            </p>
          </div>
          <div class="user-info">
            <div class="privacy-badge">
              <span>üîí</span>
              <span>Encrypted</span>
            </div>
            <button
              class="btn btn-logout"
              style="width: auto"
              onclick="logout()"
            >
              Logout
            </button>
          </div>
        </div>

        <div class="nav-tabs">
          <button class="nav-tab active" onclick="switchTab('mood')">
            Mood Check-In
          </button>
          <button class="nav-tab" onclick="switchTab('journal')">
            Journal
          </button>
          <button class="nav-tab" onclick="switchTab('insights')">
            Insights
          </button>
          <button class="nav-tab" onclick="switchTab('history')">
            Mood History
          </button>
          <button class="nav-tab" onclick="switchTab('strategies')">
            Coping Strategies
          </button>
          <button class="nav-tab" onclick="switchTab('privacy')">
            Privacy Settings
          </button>
          <button class="nav-tab" onclick="switchTab('crisis')">
            Crisis Support
          </button>
        </div>

        <!-- Mood Tab -->
        <div id="moodTab" class="tab-content active">
          <div class="mood-tracker">
            <div class="current-mood">
              <h3>How are you feeling right now?</h3>
              <p style="color: var(--gray); margin-top: 10px">
                Your mood is encrypted and never shared
              </p>
            </div>

            <div class="mood-scale">
              <button class="mood-button" onclick="selectMood(1)">üòî</button>
              <button class="mood-button" onclick="selectMood(2)">üòü</button>
              <button class="mood-button" onclick="selectMood(3)">üòï</button>
              <button class="mood-button" onclick="selectMood(4)">üòê</button>
              <button class="mood-button" onclick="selectMood(5)">üôÇ</button>
              <button class="mood-button" onclick="selectMood(6)">üòä</button>
              <button class="mood-button" onclick="selectMood(7)">üòÑ</button>
              <button class="mood-button" onclick="selectMood(8)">üòÉ</button>
              <button class="mood-button" onclick="selectMood(9)">üòÅ</button>
              <button class="mood-button" onclick="selectMood(10)">ü§©</button>
            </div>

            <h4 style="margin-top: 30px">What emotion are you experiencing?</h4>
            <div class="emotion-tags">
              <button class="emotion-tag" onclick="selectSingleEmotion(this)">
                Anxious
              </button>
              <button class="emotion-tag" onclick="selectSingleEmotion(this)">
                Stressed
              </button>
              <button class="emotion-tag" onclick="selectSingleEmotion(this)">
                Lonely
              </button>
              <button class="emotion-tag" onclick="selectSingleEmotion(this)">
                Exhausted
              </button>
              <button class="emotion-tag" onclick="selectSingleEmotion(this)">
                Confident
              </button>
              <button class="emotion-tag" onclick="selectSingleEmotion(this)">
                Motivated
              </button>
              <button class="emotion-tag" onclick="selectSingleEmotion(this)">
                Excited
              </button>
              <button class="emotion-tag" onclick="selectSingleEmotion(this)">
                Frustrated
              </button>
            </div>

            <h4 style="margin-top: 30px">What's the main context?</h4>
            <div class="emotion-tags">
              <button class="emotion-tag" onclick="selectContext(this)">
                Exams/Tests
              </button>
              <button class="emotion-tag" onclick="selectContext(this)">
                Assignments
              </button>
              <button class="emotion-tag" onclick="selectContext(this)">
                Social Life
              </button>
              <button class="emotion-tag" onclick="selectContext(this)">
                Relationships
              </button>
              <button class="emotion-tag" onclick="selectContext(this)">
                Family
              </button>
              <button class="emotion-tag" onclick="selectContext(this)">
                Financial
              </button>
              <button class="emotion-tag" onclick="selectContext(this)">
                Career/Future
              </button>
              <button class="emotion-tag" onclick="selectContext(this)">
                Health
              </button>
            </div>

            <button
              class="btn pulse"
              style="margin-top: 30px; max-width: 300px"
              onclick="saveMoodEntry()"
            >
              Save Mood Check-In
            </button>
          </div>
        </div>

        <!-- Journal Tab -->
        <div id="journalTab" class="tab-content">
          <div class="journal-entry">
            <h3>Private Journal Entry</h3>
            <div class="journal-prompt" id="journalPrompt">
              üí≠ Write anything you want to share. This space is completely
              private and encrypted.
            </div>
            <div style="margin-bottom: 15px">
              <button
                class="btn-secondary"
                onclick="toggleJournalSuggestion()"
                id="suggestionToggle"
                style="font-size: 14px; padding: 8px 15px"
              >
                üí° Need inspiration?
              </button>
            </div>
            <textarea
              class="journal-input"
              id="journalText"
              placeholder="Write freely... Your thoughts are safe here."
            ></textarea>
            <button
              class="btn"
              onclick="processJournal()"
              style="margin-top: 15px"
            >
              Get AI Support
            </button>

            <div class="ai-response" id="aiResponse" style="display: none">
              <h4>AI Insights</h4>
              <p id="aiResponseText"></p>
            </div>
          </div>

          <div class="journal-history">
            <h3>Recent Entries (Encrypted)</h3>
            <div id="journalHistory">
              <!-- Journal entries will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Insights Tab -->
        <div id="insightsTab" class="tab-content">
          <h3>Your Mood Patterns</h3>
          <div class="chart-container">
            <h4>Last 7 Days</h4>
            <div class="mood-chart" id="moodChart">
              <!-- Chart will be generated here -->
            </div>
          </div>

          <h3 style="margin-top: 30px">Detected Patterns</h3>
          <div class="pattern-cards" id="patternCards">
            <div class="pattern-card">
              <h4>üìä Loading Patterns...</h4>
              <p>Analyzing your mood and journal data...</p>
            </div>
          </div>

          <h3 style="margin-top: 30px">Journal Insights</h3>
          <div class="pattern-cards" id="journalInsights">
            <div class="pattern-card">
              <h4>üìù Loading Journal Data...</h4>
              <p>Analyzing your writing patterns...</p>
            </div>
          </div>
        </div>

        <!-- Mood History Tab -->
        <div id="historyTab" class="tab-content">
          <h3>Mood History</h3>
          <p style="color: var(--gray); margin-bottom: 20px">
            View your past mood entries and track your emotional journey
          </p>

          <div class="mood-history-container" id="moodHistoryContainer">
            <div class="pattern-card">
              <h4>üìä Loading Mood History...</h4>
              <p>Loading your past mood entries...</p>
            </div>
          </div>
        </div>

        <!-- Coping Strategies Tab -->
        <div id="strategiesTab" class="tab-content">
          <h3>Personalized Coping Strategies</h3>
          <div class="pattern-cards" id="strategiesContainer">
            <div class="pattern-card">
              <h4>üßò Loading Strategies...</h4>
              <p>Finding personalized coping techniques for you...</p>
            </div>
          </div>
        </div>

        <!-- Privacy Settings Tab -->
        <div id="privacyTab" class="tab-content">
          <h3>Privacy & Security Settings</h3>

          <div class="privacy-section">
            <h4>Data Storage</h4>
            <div class="privacy-option">
              <div>
                <strong>Local-Only Mode</strong>
                <p style="color: var(--gray); font-size: 14px">
                  Store all data only on this device
                </p>
              </div>
              <div class="toggle active" onclick="toggleSetting(this)">
                <div class="toggle-slider"></div>
              </div>
            </div>
            <div class="privacy-option">
              <div>
                <strong>Auto-Delete Old Entries</strong>
                <p style="color: var(--gray); font-size: 14px">
                  Remove entries older than 30 days
                </p>
              </div>
              <div class="toggle" onclick="toggleSetting(this)">
                <div class="toggle-slider"></div>
              </div>
            </div>
          </div>

          <div class="privacy-section">
            <h4>Security</h4>
            <div class="privacy-option">
              <div>
                <strong>Require Password on Open</strong>
                <p style="color: var(--gray); font-size: 14px">
                  Ask for password every time app opens
                </p>
              </div>
              <div class="toggle active" onclick="toggleSetting(this)">
                <div class="toggle-slider"></div>
              </div>
            </div>
            <div class="privacy-option">
              <div>
                <strong>Session Timeout</strong>
                <p style="color: var(--gray); font-size: 14px">
                  Auto-logout after 15 minutes inactive
                </p>
              </div>
              <div class="toggle active" onclick="toggleSetting(this)">
                <div class="toggle-slider"></div>
              </div>
            </div>
          </div>

          <div class="privacy-section" style="background: #fee2e2">
            <h4 style="color: var(--danger)">Danger Zone</h4>
            <button class="btn btn-danger" onclick="exportData()">
              Export All Data
            </button>
            <button
              class="btn btn-danger"
              onclick="deleteAllData()"
              style="margin-top: 10px"
            >
              Delete All Data
            </button>
            <p style="color: var(--danger); font-size: 12px; margin-top: 10px">
              ‚ö†Ô∏è This action cannot be undone
            </p>
          </div>
        </div>

        <!-- Crisis Support Tab -->
        <div id="crisisTab" class="tab-content">
          <div class="crisis-banner">
            <h3>üìû If you're in crisis, help is available</h3>
            <p>
              You don't have to go through this alone. Reach out for support.
            </p>
          </div>

          <div class="crisis-resources">
            <div class="resource-card">
              <h4>988</h4>
              <p>Suicide & Crisis Lifeline</p>
              <small>24/7 Free & Confidential</small>
            </div>
            <div class="resource-card">
              <h4>741741</h4>
              <p>Crisis Text Line</p>
              <small>Text HOME to start</small>
            </div>
            <div class="resource-card">
              <h4>Campus Counseling</h4>
              <p>Your University Services</p>
              <small>Professional support</small>
            </div>
            <div class="resource-card">
              <h4>911</h4>
              <p>Emergency Services</p>
              <small>Immediate danger</small>
            </div>
          </div>

          <div
            style="
              margin-top: 30px;
              padding: 20px;
              background: var(--light);
              border-radius: 10px;
            "
          >
            <h4>Warning Signs to Watch For:</h4>
            <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8">
              <li>Thoughts of self-harm or suicide</li>
              <li>Feeling hopeless or having no purpose</li>
              <li>Increased alcohol or drug use</li>
              <li>Withdrawing from activities and isolating</li>
              <li>Extreme mood swings</li>
              <li>Unable to sleep or sleeping all the time</li>
            </ul>
            <p
              style="margin-top: 15px; color: var(--primary); font-weight: 600"
            >
              If you notice these signs, please reach out for help immediately.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Global Alerts - Outside all containers -->
    <div class="alert success" id="successAlert"></div>
    <div class="alert error" id="errorAlert"></div>

    <script>
      // Encryption utilities
      const CryptoUtils = {
        async generateKey(password, salt) {
          const encoder = new TextEncoder();
          const keyMaterial = await crypto.subtle.importKey(
            "raw",
            encoder.encode(password),
            "PBKDF2",
            false,
            ["deriveBits", "deriveKey"]
          );

          return crypto.subtle.deriveKey(
            {
              name: "PBKDF2",
              salt: encoder.encode(salt),
              iterations: 100000,
              hash: "SHA-256",
            },
            keyMaterial,
            { name: "AES-GCM", length: 256 },
            false,
            ["encrypt", "decrypt"]
          );
        },

        async encrypt(text, password) {
          const encoder = new TextEncoder();
          const salt = crypto.getRandomValues(new Uint8Array(16));
          const iv = crypto.getRandomValues(new Uint8Array(12));
          const key = await this.generateKey(password, salt);

          const encrypted = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv },
            key,
            encoder.encode(text)
          );

          return {
            encrypted: Array.from(new Uint8Array(encrypted)),
            salt: Array.from(salt),
            iv: Array.from(iv),
          };
        },

        async decrypt(encryptedData, password) {
          const decoder = new TextDecoder();
          const key = await this.generateKey(
            password,
            new Uint8Array(encryptedData.salt)
          );

          const decrypted = await crypto.subtle.decrypt(
            { name: "AES-GCM", iv: new Uint8Array(encryptedData.iv) },
            key,
            new Uint8Array(encryptedData.encrypted)
          );

          return decoder.decode(decrypted);
        },
      };

      // Local Storage Manager
      const StorageManager = {
        setItem(key, value) {
          localStorage.setItem(key, JSON.stringify(value));
        },

        getItem(key) {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : null;
        },

        removeItem(key) {
          localStorage.removeItem(key);
        },

        clear() {
          localStorage.clear();
        },
      };

      // App State
      let currentUser = null;
      let currentMood = null;
      let selectedEmotions = [];
      let selectedContext = null;

      // Auth Functions
      function showLogin() {
        document.getElementById("loginForm").style.display = "block";
        document.getElementById("signupForm").style.display = "none";
        return false; // Prevent default link behavior
      }

      function showSignup() {
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("signupForm").style.display = "block";
        return false; // Prevent default link behavior
      }

      async function login() {
        console.log("Login function called");
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        console.log("Username:", username);
        console.log("Password length:", password.length);

        if (!username || !password) {
          showError("Please enter username and password");
          return false;
        }

        try {
          console.log("Attempting login for:", username);
          console.log("Making API call to /api/auth/login");

          // Call API for authentication
          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              username: username,
              password: password,
            }),
          });

          console.log("Response status:", response.status);
          console.log("Response ok:", response.ok);

          let data;
          try {
            data = await response.json();
            console.log("Login response:", response.status, data);
          } catch (parseError) {
            console.log("Response is not JSON, getting text instead");
            const textResponse = await response.text();
            console.log("Text response:", textResponse);
            data = { error: textResponse };
          }

          if (response.ok) {
            // Store token and user info
            localStorage.setItem("token", data.token);
            currentUser = {
              id: data.user.id,
              username: data.user.username,
              password: password, // Keep for local encryption
              yearInSchool: data.user.yearInSchool,
            };
            StorageManager.setItem("currentUser", currentUser);
            showApp();
            showSuccess("Login successful!");
          } else {
            console.log(
              "Login failed, calling showError with:",
              data.error || "Login failed"
            );
            showError(data.error || "Login failed");
            console.log("showError call completed");
          }
        } catch (error) {
          console.error("Login error:", error);
          if (error.message.includes("JSON")) {
            showError("Server returned an invalid response. Please try again.");
          } else {
            showError(
              "Connection error. Please check if the server is running on port 10000."
            );
          }
        }
        return false;
      }

      async function signup() {
        console.log("Signup function called");
        const username = document.getElementById("newUsername").value;
        const password = document.getElementById("newPassword").value;
        const year = document.getElementById("yearInSchool").value;

        if (!username || !password || !year) {
          showError("Please fill all fields");
          return false;
        }

        try {
          console.log("Attempting signup for:", username);
          // Call API for registration
          const response = await fetch("/api/auth/signup", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              username: username,
              password: password,
              yearInSchool: year,
            }),
          });

          const data = await response.json();
          console.log("Signup response:", response.status, data);

          if (response.ok) {
            // Store token and user info
            localStorage.setItem("token", data.token);
            currentUser = {
              id: data.user.id,
              username: data.user.username,
              password: password, // Keep for local encryption
              yearInSchool: year,
            };
            StorageManager.setItem("currentUser", currentUser);
            showApp();
            showSuccess("Account created successfully!");
          } else {
            showError(data.error || "Registration failed");
          }
        } catch (error) {
          console.error("Signup error:", error);
          showError(
            "Connection error. Please check if the server is running on port 10000."
          );
        }
        return false;
      }

      function logout() {
        currentUser = null;
        StorageManager.removeItem("currentUser");
        document.getElementById("authContainer").style.display = "flex";
        document.getElementById("appContainer").style.display = "none";
      }

      function showApp() {
        document.getElementById("authContainer").style.display = "none";
        document.getElementById("appContainer").style.display = "block";
        loadUserData();
        generateMoodChart();
        updateJournalPrompt();
        loadInsights();
        loadStrategies();
        loadMoodHistory();
      }

      // Tab Navigation
      function switchTab(tabName) {
        // Remove active class from all tabs and contents
        document
          .querySelectorAll(".nav-tab")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));

        // Add active class to selected tab
        event.target.classList.add("active");
        document.getElementById(tabName + "Tab").classList.add("active");
      }

      // Mood Tracking
      function selectMood(mood) {
        currentMood = mood;
        document.querySelectorAll(".mood-button").forEach((btn, index) => {
          btn.classList.toggle("selected", index + 1 === mood);
        });
      }

      function selectSingleEmotion(element) {
        // Remove selection from all other emotion buttons
        document.querySelectorAll(".emotion-tag").forEach((btn) => {
          btn.classList.remove("selected");
        });

        // Select the clicked emotion
        element.classList.add("selected");
        const emotion = element.textContent.trim();
        selectedEmotions = [emotion]; // Only one emotion allowed
      }

      function selectContext(element) {
        document.querySelectorAll(".emotion-tags button").forEach((btn) => {
          if (btn.parentElement === element.parentElement && btn !== element) {
            btn.classList.remove("selected");
          }
        });
        element.classList.toggle("selected");
        selectedContext = element.classList.contains("selected")
          ? element.textContent
          : null;
      }

      async function saveMoodEntry() {
        if (!currentMood) {
          showError("Please select your mood level");
          return;
        }

        const moodEntry = {
          mood: currentMood,
          emotions: selectedEmotions,
          context: selectedContext,
          timestamp: Date.now(),
          date: new Date().toLocaleDateString(),
        };

        try {
          // Send to API
          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("No authentication token");
          }

          const response = await fetch("/api/mood", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(moodEntry),
          });

          const data = await response.json();

          if (response.ok) {
            showSuccess("Mood check-in saved securely!");

            // Refresh page to get up-to-date insights, mood history, and strategies
            setTimeout(() => {
              window.location.reload();
            }, 1500); // Wait 1.5 seconds for user to see success message
          } else {
            showError(data.error || "Failed to save mood entry");
          }
        } catch (error) {
          console.error("Save mood error:", error);

          // Fallback to local storage if no token or API error
          if (!currentUser || !currentUser.password) {
            showError("Unable to save mood entry. Please log in again.");
            return;
          }

          const userData = StorageManager.getItem(
            `user_${currentUser.username}`
          ) || { moods: [], journals: [] };
          const encryptedMood = await CryptoUtils.encrypt(
            JSON.stringify(moodEntry),
            currentUser.password
          );
          userData.moods.push(encryptedMood);
          StorageManager.setItem(`user_${currentUser.username}`, userData);
          showSuccess("Mood check-in saved locally!");

          // Refresh page to get up-to-date insights, mood history, and strategies
          setTimeout(() => {
            window.location.reload();
          }, 1500); // Wait 1.5 seconds for user to see success message
        }
      }

      // Journal Functions
      async function processJournal() {
        const journalText = document.getElementById("journalText").value;
        if (!journalText) {
          showError("Please write something in your journal");
          return;
        }

        try {
          // Send to API for AI processing
          const token = localStorage.getItem("token");
          const response = await fetch("/api/journal", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ text: journalText }),
          });

          const data = await response.json();

          if (response.ok) {
            // Display AI response
            document.getElementById("aiResponseText").textContent =
              data.aiResponse;
            document.getElementById("aiResponse").style.display = "block";
            showSuccess("Journal entry saved and processed!");
            loadJournalHistory();
            loadInsights();
          } else {
            // Fallback to local processing
            throw new Error(data.error);
          }
        } catch (error) {
          console.error("Journal API error:", error);

          // Fallback: Save locally and provide basic response
          const journalEntry = {
            text: journalText,
            timestamp: Date.now(),
            date: new Date().toLocaleDateString(),
          };

          // Generate AI response for local storage
          const aiResponse = generateAIResponse(journalText);
          journalEntry.ai_response = aiResponse;

          const userData = StorageManager.getItem(
            `user_${currentUser.username}`
          ) || { moods: [], journals: [] };
          const encryptedJournal = await CryptoUtils.encrypt(
            JSON.stringify(journalEntry),
            currentUser.password
          );
          userData.journals.push(encryptedJournal);
          StorageManager.setItem(`user_${currentUser.username}`, userData);

          // Provide local AI response
          document.getElementById("aiResponseText").textContent = aiResponse;
          document.getElementById("aiResponse").style.display = "block";

          showSuccess("Journal entry saved locally!");
          loadJournalHistory();
          loadInsights();
        }
      }

      function generateAIResponse(text) {
        // Simplified AI response simulation
        // In production, this would call your LLM API
        const responses = {
          stress:
            "I understand you're feeling stressed. Remember that it's normal to feel overwhelmed during college. Try breaking down your tasks into smaller, manageable pieces. Consider using the Pomodoro technique from the Coping Strategies tab.",
          anxiety:
            "Anxiety is a common experience for many students. The breathing exercises in the Coping Strategies section can help calm your nervous system. Also, remember that your campus counseling center is always available.",
          lonely:
            "Feeling lonely in college is more common than you might think. Consider joining a study group or campus organization. Small steps toward connection can make a big difference.",
          default:
            "Thank you for sharing. Your feelings are valid and it's healthy to express them. Based on what you've written, consider exploring the coping strategies that resonate most with you.",
        };

        // Simple keyword detection
        const lowerText = text.toLowerCase();
        if (lowerText.includes("stress") || lowerText.includes("overwhelm"))
          return responses.stress;
        if (lowerText.includes("anxious") || lowerText.includes("anxiety"))
          return responses.anxiety;
        if (lowerText.includes("lonely") || lowerText.includes("alone"))
          return responses.lonely;
        return responses.default;
      }

      function updateJournalPrompt() {
        const prompts = [
          "üí≠ What's on your mind today? This space is completely private and encrypted.",
          "üìù How did today go? What challenged you and what went well?",
          "üåü What are three things you're grateful for today?",
          "üéØ What's one small goal you can set for tomorrow?",
          "üí™ What strength did you discover in yourself recently?",
          "üåà Describe a moment today that made you smile.",
          "üìö How are you balancing academics and self-care?",
          "ü§ù How are your relationships affecting your wellbeing?",
          "üåô How has your sleep been affecting your mood lately?",
          "üèÉ‚Äç‚ôÄÔ∏è What physical activity or exercise made you feel good recently?",
          "üçΩÔ∏è How is your relationship with food and nutrition?",
          "üé® What creative outlet brings you joy?",
          "üìñ What book, movie, or music resonated with you recently?",
          "üå± What personal growth have you noticed in yourself?",
          "üè† How does your living environment impact your mental state?",
          "üíº What work or academic challenges are you facing?",
          "üéì What are your biggest concerns about your education?",
          "üí∞ How are financial worries affecting your wellbeing?",
          "üë• Who are the people that support you the most?",
          "üåç What global or local events are on your mind?",
          "üé≠ What role or identity are you exploring right now?",
          "üîÆ What are your hopes and dreams for the future?",
          "‚öñÔ∏è How are you finding balance in your life?",
          "üé™ What fun or exciting things are you looking forward to?",
          "üßò‚Äç‚ôÄÔ∏è What helps you feel calm and centered?",
          "üéØ What's one thing you'd like to improve about yourself?",
          "üíù What acts of kindness have you given or received?",
          "üåÖ What's your ideal morning routine?",
          "üåÉ What helps you wind down at the end of the day?",
          "üé® What would your perfect day look like?",
          "üîç What patterns have you noticed in your thoughts lately?",
        ];

        const randomPrompt =
          prompts[Math.floor(Math.random() * prompts.length)];
        document.getElementById("journalPrompt").textContent = randomPrompt;
      }

      function toggleJournalSuggestion() {
        const promptElement = document.getElementById("journalPrompt");
        const toggleButton = document.getElementById("suggestionToggle");

        if (
          promptElement.textContent.includes("Write anything you want to share")
        ) {
          // Show suggestion
          updateJournalPrompt();
          toggleButton.textContent = "üí≠ Write freely";
        } else {
          // Show free writing prompt
          promptElement.textContent =
            "üí≠ Write anything you want to share. This space is completely private and encrypted.";
          toggleButton.textContent = "üí° Need inspiration?";
        }
      }

      async function loadJournalHistory() {
        const historyContainer = document.getElementById("journalHistory");
        if (!historyContainer) return;

        historyContainer.innerHTML = "";

        try {
          const token = localStorage.getItem("token");
          if (token) {
            // Try to fetch from API
            const response = await fetch("/api/journal/history", {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });

            if (response.ok) {
              const journalData = await response.json();

              // Display last 5 journal entries
              const recentJournals = journalData.slice(-5).reverse();
              for (const journal of recentJournals) {
                const journalItem = document.createElement("div");
                journalItem.className = "journal-item";
                journalItem.innerHTML = `
                  <strong>${new Date(journal.created_at).toLocaleDateString()}</strong>
                  <p style="margin-top: 5px; color: var(--gray);">
                    ${journal.text.substring(0, 100)}${journal.text.length > 100 ? "..." : ""}
                  </p>
                `;

                // Add click event to show journal details
                journalItem.addEventListener("click", () => {
                  showJournalModal(journal);
                });

                historyContainer.appendChild(journalItem);
              }

              if (recentJournals.length === 0) {
                historyContainer.innerHTML =
                  '<p style="color: var(--gray);">No journal entries yet. Start writing to track your thoughts!</p>';
              }
              return;
            }
          }
        } catch (error) {
          console.error("Error loading journal history:", error);
        }

        // Fallback to local storage if API fails
        const userData = StorageManager.getItem(
          `user_${currentUser.username}`
        ) || { moods: [], journals: [] };

        const recentJournals = userData.journals.slice(-5).reverse();
        for (const encryptedJournal of recentJournals) {
          try {
            const decrypted = await CryptoUtils.decrypt(
              encryptedJournal,
              currentUser.password
            );
            const journal = JSON.parse(decrypted);

            const journalItem = document.createElement("div");
            journalItem.className = "journal-item";
            journalItem.innerHTML = `
              <strong>${journal.date}</strong>
              <p style="margin-top: 5px; color: var(--gray);">
                ${journal.text.substring(0, 100)}${journal.text.length > 100 ? "..." : ""}
              </p>
            `;

            // Add click event to show journal details
            journalItem.addEventListener("click", () => {
              showJournalModal(journal);
            });

            historyContainer.appendChild(journalItem);
          } catch (e) {
            console.error("Error decrypting journal entry");
          }
        }

        if (recentJournals.length === 0) {
          historyContainer.innerHTML =
            '<p style="color: var(--gray);">No journal entries yet. Start writing to track your thoughts!</p>';
        }
      }

      // Insights and Charts
      let isGeneratingChart = false;
      let chartGenerationCount = 0;
      async function generateMoodChart() {
        const chartContainer = document.getElementById("moodChart");
        if (!chartContainer) return;

        // Prevent multiple simultaneous chart generations
        if (isGeneratingChart) {
          console.log("‚ö†Ô∏è Chart generation already in progress, skipping...");
          return;
        }
        isGeneratingChart = true;
        chartGenerationCount++;

        console.log(
          `üîÑ Generating mood chart... (attempt #${chartGenerationCount})`
        );
        chartContainer.innerHTML = "";

        // Get last 7 days
        const last7Days = [];
        const today = new Date();
        for (let i = 6; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          last7Days.push(date.toLocaleDateString());
        }

        console.log("üìÖ Last 7 days:", last7Days);
        let moodsByDay = {};

        try {
          const token = localStorage.getItem("token");
          if (token) {
            // Try to fetch from API
            const response = await fetch("/api/mood/history?limit=7", {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });

            if (response.ok) {
              const moodData = await response.json();

              // Aggregate mood data by day
              moodData.forEach((entry) => {
                const entryDate = new Date(entry.date).toLocaleDateString();
                if (last7Days.includes(entryDate)) {
                  if (!moodsByDay[entryDate]) {
                    moodsByDay[entryDate] = [];
                  }
                  moodsByDay[entryDate].push(entry.mood);
                }
              });
            } else {
              // If API fails, fall back to local data
              const userData = StorageManager.getItem(
                `user_${currentUser.username}`
              ) || { moods: [], journals: [] };

              // Decrypt and aggregate mood data
              for (const encryptedMood of userData.moods) {
                try {
                  const decrypted = await CryptoUtils.decrypt(
                    encryptedMood,
                    currentUser.password
                  );
                  const mood = JSON.parse(decrypted);
                  if (last7Days.includes(mood.date)) {
                    if (!moodsByDay[mood.date]) {
                      moodsByDay[mood.date] = [];
                    }
                    moodsByDay[mood.date].push(mood.mood);
                  }
                } catch (e) {
                  console.error("Error decrypting mood entry");
                }
              }
            }
          } else {
            // No token, use local data
            const userData = StorageManager.getItem(
              `user_${currentUser.username}`
            ) || { moods: [], journals: [] };

            // Decrypt and aggregate mood data
            for (const encryptedMood of userData.moods) {
              try {
                const decrypted = await CryptoUtils.decrypt(
                  encryptedMood,
                  currentUser.password
                );
                const mood = JSON.parse(decrypted);
                if (last7Days.includes(mood.date)) {
                  if (!moodsByDay[mood.date]) {
                    moodsByDay[mood.date] = [];
                  }
                  moodsByDay[mood.date].push(mood.mood);
                }
              } catch (e) {
                console.error("Error decrypting mood entry");
              }
            }
          }
        } catch (error) {
          console.error("Error fetching mood history:", error);

          // Fallback to local data on error
          const userData = StorageManager.getItem(
            `user_${currentUser.username}`
          ) || { moods: [], journals: [] };

          // Decrypt and aggregate mood data
          for (const encryptedMood of userData.moods) {
            try {
              const decrypted = await CryptoUtils.decrypt(
                encryptedMood,
                currentUser.password
              );
              const mood = JSON.parse(decrypted);
              if (last7Days.includes(mood.date)) {
                if (!moodsByDay[mood.date]) {
                  moodsByDay[mood.date] = [];
                }
                moodsByDay[mood.date].push(mood.mood);
              }
            } catch (e) {
              console.error("Error decrypting mood entry");
            }
          }
        }

        // Create chart bars (only once)
        console.log("üìä Moods by day:", moodsByDay);
        last7Days.forEach((date) => {
          const dayMoods = moodsByDay[date] || [];
          const avgMood =
            dayMoods.length > 0
              ? dayMoods.reduce((a, b) => a + b, 0) / dayMoods.length
              : 0;

          console.log(
            `üìà ${date}: ${dayMoods.length} entries, avg mood: ${avgMood}`
          );

          const bar = document.createElement("div");
          bar.className = "chart-bar";
          bar.style.height = `${avgMood * 30}px`;

          const label = document.createElement("div");
          label.className = "chart-label";
          label.textContent = date.split("/")[0] + "/" + date.split("/")[1];
          bar.appendChild(label);

          chartContainer.appendChild(bar);
        });
        console.log("‚úÖ Chart generation complete");
        isGeneratingChart = false;
      }

      // Privacy Functions
      function toggleSetting(element) {
        element.classList.toggle("active");
      }

      async function exportData() {
        if (
          !confirm(
            "Export all your data? This will create a downloadable file."
          )
        )
          return;

        try {
          const token = localStorage.getItem("token");
          if (!token) {
            showError("Please log in to export data");
            return;
          }

          const response = await fetch("/api/privacy/export", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const userData = await response.json();
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], { type: "application/json" });

            const link = document.createElement("a");
            link.href = URL.createObjectURL(dataBlob);
            link.download = `mindpath_backup_${Date.now()}.json`;
            link.click();

            showSuccess("Data exported successfully!");
          } else {
            showError("Failed to export data");
          }
        } catch (error) {
          console.error("Export error:", error);
          showError("Failed to export data");
        }
      }

      function deleteAllData() {
        if (!confirm("Delete ALL your data? This cannot be undone!")) return;
        if (
          !confirm(
            "Are you absolutely sure? All mood tracking and journal entries will be permanently deleted."
          )
        )
          return;

        StorageManager.removeItem(`user_${currentUser.username}`);
        showSuccess("All data has been deleted");
        setTimeout(() => location.reload(), 1500);
      }

      // Pattern Detection
      function checkForConcerningPatterns(moodEntry) {
        // Check for consistently low mood
        if (moodEntry.mood <= 3) {
          const concerningEmotions = [
            "Anxious",
            "Stressed",
            "Overwhelmed",
            "Lonely",
          ];
          const hasConeerning = selectedEmotions.some((e) =>
            concerningEmotions.includes(e)
          );

          if (hasConeerning) {
            setTimeout(() => {
              if (
                confirm(
                  "We noticed you might be going through a tough time. Would you like to see crisis resources?"
                )
              ) {
                switchTab("crisis");
              }
            }, 2000);
          }
        }
      }

      // Utility Functions
      function showSuccess(message) {
        console.log("showSuccess called with:", message);
        const alert = document.getElementById("successAlert");
        if (alert) {
          alert.textContent = message;
          alert.style.display = "block";
          alert.style.visibility = "visible";
          alert.style.opacity = "1";
          console.log("Updated existing success alert");
          setTimeout(() => {
            alert.style.display = "none";
            console.log("Hidden success alert after timeout");
          }, 3000);
        } else {
          // Create alert if it doesn't exist
          const newAlert = document.createElement("div");
          newAlert.className = "alert success";
          newAlert.id = "successAlert";
          newAlert.textContent = message;
          newAlert.style.display = "block";
          newAlert.style.visibility = "visible";
          newAlert.style.opacity = "1";
          newAlert.style.position = "fixed";
          newAlert.style.top = "20px";
          newAlert.style.right = "20px";
          newAlert.style.zIndex = "9999";
          document.body.appendChild(newAlert);
          console.log("Created new success alert");
          setTimeout(() => {
            newAlert.style.display = "none";
            console.log("Hidden new success alert after timeout");
          }, 3000);
        }
        console.log("Success displayed:", message);
      }

      function showError(message) {
        console.log("showError called with:", message);
        const alert = document.getElementById("errorAlert");
        if (alert) {
          alert.innerHTML = `‚ùå ${message}`;
          alert.style.display = "block";
          alert.style.visibility = "visible";
          alert.style.opacity = "1";
          console.log("Updated existing error alert");
          setTimeout(() => {
            alert.style.display = "none";
            console.log("Hidden error alert after timeout");
          }, 8000);
        } else {
          // Create alert if it doesn't exist
          const newAlert = document.createElement("div");
          newAlert.className = "alert error";
          newAlert.id = "errorAlert";
          newAlert.innerHTML = `‚ùå ${message}`;
          newAlert.style.display = "block";
          newAlert.style.visibility = "visible";
          newAlert.style.opacity = "1";
          newAlert.style.position = "fixed";
          newAlert.style.top = "20px";
          newAlert.style.right = "20px";
          newAlert.style.zIndex = "99999";
          document.body.appendChild(newAlert);
          console.log("Created new error alert");
          setTimeout(() => {
            newAlert.style.display = "none";
            console.log("Hidden new error alert after timeout");
          }, 8000);
        }
        console.error("Error displayed:", message);
      }

      async function loadUserData() {
        loadJournalHistory();
        // generateMoodChart() is already called in showApp(), so we don't need to call it here
      }

      async function loadInsights() {
        try {
          const token = localStorage.getItem("token");
          if (!token) return;

          // Load mood patterns
          const moodResponse = await fetch("/api/insights/patterns", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (moodResponse.ok) {
            const moodData = await moodResponse.json();
            displayMoodPatterns(moodData);
          }

          // Load journal insights
          const journalResponse = await fetch("/api/insights/journal", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (journalResponse.ok) {
            const journalData = await journalResponse.json();
            displayJournalInsights(journalData);
          }
        } catch (error) {
          console.error("Error loading insights:", error);
        }
      }

      function displayMoodPatterns(data) {
        const container = document.getElementById("patternCards");
        if (!container) return;

        if (data.dataPoints === 0) {
          container.innerHTML = `
                    <div class="pattern-card">
                        <h4>üìä No Data Yet</h4>
                        <p>Start tracking your mood to see personalized insights!</p>
                    </div>
                `;
          return;
        }

        const patterns = [];

        // Mood trend
        if (data.moodTrend !== "neutral") {
          patterns.push({
            icon: data.moodTrend === "improving" ? "üìà" : "üìâ",
            title: `Mood ${data.moodTrend.charAt(0).toUpperCase() + data.moodTrend.slice(1)}`,
            description: `Your mood has been ${data.moodTrend} over the past 30 days.`,
          });
        }

        // Common emotions
        if (data.commonEmotions.length > 0) {
          const topEmotion = data.commonEmotions[0];
          patterns.push({
            icon: "üòä",
            title: "Most Common Emotion",
            description: `You've been feeling ${topEmotion.emotion.toLowerCase()} ${Math.round(topEmotion.frequency * 100)}% of the time.`,
          });
        }

        // Stress patterns
        if (data.stressPatterns.length > 0) {
          const topStress = data.stressPatterns[0];
          patterns.push({
            icon: "üìö",
            title: "Academic Stress",
            description: `${topStress.context} appears in ${topStress.percentage}% of your mood entries.`,
          });
        }

        // Recommendations
        if (data.recommendations.length > 0) {
          const rec = data.recommendations[0];
          patterns.push({
            icon: "üí°",
            title: rec.title,
            description: rec.description,
          });
        }

        // Fallback if no patterns detected
        if (patterns.length === 0) {
          patterns.push({
            icon: "üìä",
            title: "Building Insights",
            description:
              "Continue tracking your mood to see personalized patterns and recommendations.",
          });
        }

        container.innerHTML = patterns
          .map(
            (pattern) => `
                <div class="pattern-card">
                    <h4>${pattern.icon} ${pattern.title}</h4>
                    <p>${pattern.description}</p>
                </div>
            `
          )
          .join("");
      }

      function displayJournalInsights(data) {
        const container = document.getElementById("journalInsights");
        if (!container) return;

        if (data.totalEntries === 0) {
          container.innerHTML = `
                    <div class="pattern-card">
                        <h4>üìù No Journal Entries</h4>
                        <p>Start journaling to see writing insights and patterns!</p>
                    </div>
                `;
          return;
        }

        const insights = [];

        // Writing frequency
        insights.push({
          icon: "üìÖ",
          title: "Writing Frequency",
          description: `You write ${data.writingFrequency} with an average of ${data.averageLength} characters per entry.`,
        });

        // Common themes
        if (data.commonThemes.length > 0) {
          const topTheme = data.commonThemes[0];
          insights.push({
            icon: "üéØ",
            title: "Common Theme",
            description: `You often write about ${topTheme.theme} (${topTheme.percentage}% of entries).`,
          });
        }

        // Total entries
        insights.push({
          icon: "üìñ",
          title: "Journal Activity",
          description: `You've written ${data.totalEntries} entries in the last 30 days.`,
        });

        container.innerHTML = insights
          .map(
            (insight) => `
                <div class="pattern-card">
                    <h4>${insight.icon} ${insight.title}</h4>
                    <p>${insight.description}</p>
                </div>
            `
          )
          .join("");
      }

      async function loadStrategies() {
        try {
          const token = localStorage.getItem("token");
          if (!token) return;

          const response = await fetch("/api/strategies", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            const strategies = await response.json();
            console.log("üìä Received strategies from server:", strategies);
            displayStrategies(strategies);
          } else {
            console.error("‚ùå Server returned error status:", response.status);
            const errorText = await response.text();
            console.error("‚ùå Error response:", errorText);
            throw new Error(`Server error: ${response.status}`);
          }
        } catch (error) {
          console.error("Error loading strategies:", error);
          console.log("üîÑ Falling back to static strategies due to error");
          // Fallback to static strategies
          displayStrategies(getFallbackStrategies());
        }
      }

      function displayStrategies(strategies) {
        const container = document.getElementById("strategiesContainer");
        if (!container) return;

        if (strategies.length === 0) {
          container.innerHTML = `
                    <div class="pattern-card">
                        <h4>üßò No Strategies Available</h4>
                        <p>Start tracking your mood to get personalized coping strategies!</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = strategies
          .map(
            (strategy) => `
                <div class="pattern-card">
                    <h4>${getStrategyIcon(strategy.category)} ${strategy.title}</h4>
                    <p><strong>${strategy.description}</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        ${strategy.steps.map((step) => `<li>${step}</li>`).join("")}
                    </ul>
                </div>
            `
          )
          .join("");
      }

      function getStrategyIcon(category) {
        const icons = {
          quick: "‚ö°",
          academic: "üìö",
          sleep: "üåô",
          social: "ü§ù",
          stress: "üßò",
          focus: "üéØ",
          physical: "üí™",
          mindfulness: "üßò‚Äç‚ôÄÔ∏è",
          nutrition: "üçé",
          emotional: "üí≠",
          creative: "üé®",
          routine: "‚è∞",
          financial: "üí∞",
          technology: "üì±",
          gratitude: "üôè",
          environment: "üè†",
        };
        return icons[category] || "üí°";
      }

      function getFallbackStrategies() {
        return [
          {
            id: 1,
            category: "quick",
            title: "Box Breathing (5 min)",
            description: "A simple technique to calm your nervous system",
            steps: [
              "Inhale for 4 counts",
              "Hold for 4 counts",
              "Exhale for 4 counts",
              "Hold for 4 counts",
              "Repeat 4-5 times",
            ],
          },
          {
            id: 2,
            category: "academic",
            title: "Pomodoro Technique",
            description: "Improve focus and reduce study stress",
            steps: [
              "25 minutes focused work",
              "5 minute break",
              "Repeat 4 times",
              "15-30 minute long break",
            ],
          },
          {
            id: 3,
            category: "physical",
            title: "5-Minute Movement Break",
            description: "Quick physical activity to boost mood and energy",
            steps: [
              "Stand up and stretch",
              "Do 10 jumping jacks",
              "Walk around your room",
              "Do 5 push-ups or wall push-ups",
              "Take 5 deep breaths",
            ],
          },
          {
            id: 4,
            category: "gratitude",
            title: "Gratitude Practice",
            description: "Shift focus to positive aspects of life",
            steps: [
              "Write down 3 things you're grateful for",
              "Thank someone who helped you",
              "Notice small moments of joy",
              "Reflect on your progress",
              "Share appreciation with others",
            ],
          },
        ];
      }

      // Mood History Functions
      async function loadMoodHistory() {
        try {
          const token = localStorage.getItem("token");
          if (!token) return;

          const response = await fetch("/api/mood/history", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            const moodData = await response.json();
            displayMoodHistory(moodData);
          }
        } catch (error) {
          console.error("Error loading mood history:", error);
          // Fallback to local data
          displayMoodHistory([]);
        }
      }

      function displayMoodHistory(moodData) {
        const container = document.getElementById("moodHistoryContainer");
        if (!container) return;

        if (moodData.length === 0) {
          container.innerHTML = `
                    <div class="pattern-card">
                        <h4>üìä No Mood History</h4>
                        <p>Start tracking your mood to see your emotional journey!</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = moodData
          .map((entry) => {
            const date = new Date(entry.created_at || entry.timestamp);
            const moodEmoji = getMoodEmoji(entry.mood);

            return `
                    <div class="mood-history-item">
                        <div class="mood-history-header">
                            <div class="mood-history-date">${date.toLocaleDateString()}</div>
                            <div class="mood-history-time">${date.toLocaleTimeString()}</div>
                        </div>
                        <div class="mood-history-rating">
                            <span class="mood-emoji">${moodEmoji}</span>
                            <span class="mood-score">Mood: ${entry.mood}/10</span>
                        </div>
                        ${
                          entry.emotions && entry.emotions.length > 0
                            ? `
                            <div class="mood-history-emotions">
                                ${entry.emotions.map((emotion) => `<span class="mood-history-emotion">${emotion}</span>`).join("")}
                            </div>
                        `
                            : ""
                        }
                        ${
                          entry.context
                            ? `
                            <div class="mood-history-context">
                                <strong>Context:</strong> ${entry.context}
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;
          })
          .join("");
      }

      function getMoodEmoji(mood) {
        const emojis = [
          "üòî",
          "üòü",
          "üòï",
          "üòê",
          "üôÇ",
          "üòä",
          "üòÑ",
          "üòÉ",
          "üòÅ",
          "ü§©",
        ];
        return (
          emojis[Math.max(0, Math.min(mood - 1, emojis.length - 1))] || "üòê"
        );
      }

      // Journal Modal Functions
      function showJournalModal(journal) {
        const modal = document.getElementById("journalModal");
        const dateElement = document.getElementById("modalJournalDate");
        const textElement = document.getElementById("modalJournalText");
        const feedbackElement = document.getElementById("modalAIFeedback");

        // Format date
        const date = journal.created_at || journal.date;
        const formattedDate = new Date(date).toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });

        // Set content
        dateElement.textContent = formattedDate;
        textElement.textContent = journal.text;

        // Set AI feedback
        if (journal.ai_response) {
          feedbackElement.textContent = journal.ai_response;
        } else {
          feedbackElement.textContent =
            "No AI feedback available for this entry.";
        }

        // Show modal
        modal.classList.add("show");

        // Prevent body scroll
        document.body.style.overflow = "hidden";
      }

      function closeJournalModal() {
        const modal = document.getElementById("journalModal");
        modal.classList.remove("show");

        // Restore body scroll
        document.body.style.overflow = "auto";
      }

      // Close modal when clicking outside
      document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("journalModal");
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            closeJournalModal();
          }
        });

        // Close modal with Escape key
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            closeJournalModal();
          }
        });
      });

      // Session Management
      let inactivityTimer;
      function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(
          () => {
            if (currentUser) {
              logout();
              alert("Session expired for your security. Please log in again.");
            }
          },
          15 * 60 * 1000
        ); // 15 minutes
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        // Check for existing session
        const savedUser = StorageManager.getItem("currentUser");
        if (savedUser) {
          currentUser = savedUser;
          showApp();
        }

        // Set up inactivity timer
        document.addEventListener("click", resetInactivityTimer);
        document.addEventListener("keypress", resetInactivityTimer);
        resetInactivityTimer();
      });

      // Initialize journal prompt (no periodic updates - user controls via toggle)
      updateJournalPrompt();
    </script>

    <!-- Journal Modal -->
    <div id="journalModal" class="modal-overlay">
      <div class="journal-modal">
        <div class="modal-header">
          <h3 class="modal-title">üìù Journal Entry</h3>
          <button class="modal-close" onclick="closeJournalModal()">
            &times;
          </button>
        </div>
        <div class="journal-content">
          <div class="journal-date" id="modalJournalDate"></div>
          <div class="journal-text" id="modalJournalText"></div>
        </div>
        <div class="ai-feedback">
          <h4>ü§ñ AI Support Feedback</h4>
          <div class="ai-feedback-content" id="modalAIFeedback"></div>
        </div>
      </div>
    </div>
  </body>
</html>
